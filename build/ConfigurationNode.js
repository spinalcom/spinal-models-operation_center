"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _SpinalBIMGroupOC = require("./SpinalBIMGroupOC");

var _SpinalBIMGroupOC2 = _interopRequireDefault(_SpinalBIMGroupOC);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const spinalCore = require("spinal-core-connectorjs");
const globalType = typeof window === "undefined" ? global : window;

let getViewer = function () {
  return globalType.v;
};

class ConfigurationNode extends globalType.Model {
  constructor(_newParent, _type, _options) {
    super();
    if (FileSystem._sig_server) {
      if (_newParent === 0) this.add_attr({
        relOptions: _options
      });
      this.add_attr({
        id: this.guid(),
        title: "",
        children: new Lst(),
        showContent: false,
        BIMGroup: new _SpinalBIMGroupOC2.default(this),
        childNameId: 0,
        parent: new Ptr(_newParent),
        type: new Choice(0, ["Zone", "Equipement"])
      });
      this.type.set(_type || "Zone");
    }
  }

  //commun for all types
  incrementChildNameId() {
    this.childNameId.set(this.childNameId.get() + 1);
    return this.childNameId.get();
  }

  guid() {
    return this.s4() + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + this.s4() + this.s4();
  }

  s4() {
    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
  }

  createChild(_type) {
    let child = new ConfigurationNode(this, _type);

    // console.log("type", _type);
    if (_type === "Zone") {
      let parentTitle = this.title.get();
      child.setTitle(parentTitle + "-" + this.incrementChildNameId().toString());
    } else if (_type === "Equipement") {
      child.setTitle("Equipement" + "-" + this.incrementChildNameId().toString());
    }
    this.addChild(child);
  }

  addChild(child, index) {
    if (typeof index == "undefined") this.children.push(child);
    // else
    //   this.children.push()
  }

  addChildren(children) {
    for (let i = 0; i < children.length; i++) {
      this.children.push(children[i]);
    }
  }

  getChildren() {
    return this.children.get();
  }

  getTitle() {
    return this.title.get();
  }

  setTitle(title) {
    this.title.set(title);
  }

  removeChildren() {
    this.children.set(null);
  }

  isLeaf() {
    if (this.children.length == 0) return true;else return false;
  }

  isEquipement() {
    return this.type.get() === "Equipement";
  }

  getEquipements() {
    let equipementsArray = [];
    for (let i = 0; i < this.children.length; i++) {
      const equip = this.children[i];
      // console.log("recur", equip.type.get());
      // console.log(equipementsArray);
      // console.log(equip.isEquipement());
      if (equip.isEquipement()) equipementsArray = equipementsArray.concat(equip);else equipementsArray = equipementsArray.concat(equip.getEquipements());
    }
    return equipementsArray;
  }

  getAllBIMGroups() {
    let res = [];
    res.push(this.BIMGroup);
    for (let i = 0; i < this.children.length; i++) {
      const child = this.children[i];
      res = res.concat(child.getAllBIMGroups());
    }
    return res;
  }

  test() {
    console.log(this);
  }

  getItems() {
    let t = [];
    t = t.concat(this.BIMGroup.arrayOfId());
    for (let i = 0; i < this.children.length; i++) {
      const element = this.children[i];
      let childItems = element.getItems();
      for (let i = 0; i < childItems.length; i++) {
        const element = childItems[i];
        if (t.indexOf(element) === -1) t.push(element);
      }
    }
    return t;
  }

  setAllDisplays(_bool) {
    let t = this.getAllBIMGroups();
    for (let index = 0; index < t.length; index++) {
      const element = t[index];
      element.display.set(_bool);
    }
  }

  setAllDatasActive(_bool) {
    let t = this.getAllBIMGroups();
    for (let index = 0; index < t.length; index++) {
      const element = t[index];
      element.active.set(_bool);
    }
  }

  setParent(parent) {
    this.parent.set(parent);
  }

  modParent(parent) {
    if (this.parent.constructor.name === parent.constructor.name) this.parent.set(parent);else {
      this.mod_attr("parent", parent);
      // this.mod_attr('parent', parent);
      // console.log(this.parent.constructor.name);
    }
  }

  getParent(cb, rej) {
    this.parent.load(parent => {
      if (typeof cb != "undefined") cb(parent);else rej(new Error("Parent"));
    });
  }
  getParentAsync() {
    return new Promise((resolve, reject) => {
      // console.log(this.parent);
      this.getParent(resolve, reject);
    });
  }
  removeParent() {
    // this.modParent(new globalType.Ptr(0));
    this.setParent(0);
  }

  remove() {
    if (!this.isRoot()) {
      this.getParent(parent => {
        parent.children.remove(this);
        delete globalType.FileSystem._objects[this._server_id];
      });
    }
  }

  isRoot() {
    return this.parent.constructor.name === "Ptr" && this.parent.data.value === 0;
  }

  async getRoot() {
    if (this.isRoot()) {
      return new Promise((resolve, reject) => {
        resolve(this);
        // reject(new Error("fail"));
      });
    } else {
      try {
        let rootCandidate = await this.getParentAsync();
        return new Promise(async function (resolve, reject) {
          try {
            // console.log(rootCandidate.title.get());
            let root = await rootCandidate.getRoot();
            resolve(root);
          } catch (error) {
            console.error(error);
            reject(new Error("Error"));
          }
        });
      } catch (error) {
        console.error(error);
      }
    }
  }

  updateShowContent(bool) {
    if (typeof bool != "undefined") {
      this.showContent.set(bool);
      return;
    }
    if (this.children.length === 0 && this.BIMGroup.BIMObjects.length === 0) this.showContent.set(false);
  }
}

exports.default = ConfigurationNode;
spinalCore.register_models([ConfigurationNode]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25maWd1cmF0aW9uTm9kZS5qcyJdLCJuYW1lcyI6WyJzcGluYWxDb3JlIiwicmVxdWlyZSIsImdsb2JhbFR5cGUiLCJ3aW5kb3ciLCJnbG9iYWwiLCJnZXRWaWV3ZXIiLCJ2IiwiQ29uZmlndXJhdGlvbk5vZGUiLCJNb2RlbCIsImNvbnN0cnVjdG9yIiwiX25ld1BhcmVudCIsIl90eXBlIiwiX29wdGlvbnMiLCJGaWxlU3lzdGVtIiwiX3NpZ19zZXJ2ZXIiLCJhZGRfYXR0ciIsInJlbE9wdGlvbnMiLCJpZCIsImd1aWQiLCJ0aXRsZSIsImNoaWxkcmVuIiwiTHN0Iiwic2hvd0NvbnRlbnQiLCJCSU1Hcm91cCIsIlNwaW5hbEJJTUdyb3VwT0MiLCJjaGlsZE5hbWVJZCIsInBhcmVudCIsIlB0ciIsInR5cGUiLCJDaG9pY2UiLCJzZXQiLCJpbmNyZW1lbnRDaGlsZE5hbWVJZCIsImdldCIsInM0IiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwidG9TdHJpbmciLCJzdWJzdHJpbmciLCJjcmVhdGVDaGlsZCIsImNoaWxkIiwicGFyZW50VGl0bGUiLCJzZXRUaXRsZSIsImFkZENoaWxkIiwiaW5kZXgiLCJwdXNoIiwiYWRkQ2hpbGRyZW4iLCJpIiwibGVuZ3RoIiwiZ2V0Q2hpbGRyZW4iLCJnZXRUaXRsZSIsInJlbW92ZUNoaWxkcmVuIiwiaXNMZWFmIiwiaXNFcXVpcGVtZW50IiwiZ2V0RXF1aXBlbWVudHMiLCJlcXVpcGVtZW50c0FycmF5IiwiZXF1aXAiLCJjb25jYXQiLCJnZXRBbGxCSU1Hcm91cHMiLCJyZXMiLCJ0ZXN0IiwiY29uc29sZSIsImxvZyIsImdldEl0ZW1zIiwidCIsImFycmF5T2ZJZCIsImVsZW1lbnQiLCJjaGlsZEl0ZW1zIiwiaW5kZXhPZiIsInNldEFsbERpc3BsYXlzIiwiX2Jvb2wiLCJkaXNwbGF5Iiwic2V0QWxsRGF0YXNBY3RpdmUiLCJhY3RpdmUiLCJzZXRQYXJlbnQiLCJtb2RQYXJlbnQiLCJuYW1lIiwibW9kX2F0dHIiLCJnZXRQYXJlbnQiLCJjYiIsInJlaiIsImxvYWQiLCJFcnJvciIsImdldFBhcmVudEFzeW5jIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJyZW1vdmVQYXJlbnQiLCJyZW1vdmUiLCJpc1Jvb3QiLCJfb2JqZWN0cyIsIl9zZXJ2ZXJfaWQiLCJkYXRhIiwidmFsdWUiLCJnZXRSb290Iiwicm9vdENhbmRpZGF0ZSIsInJvb3QiLCJlcnJvciIsInVwZGF0ZVNob3dDb250ZW50IiwiYm9vbCIsIkJJTU9iamVjdHMiLCJyZWdpc3Rlcl9tb2RlbHMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBOzs7Ozs7QUFGQSxNQUFNQSxhQUFhQyxRQUFRLHlCQUFSLENBQW5CO0FBQ0EsTUFBTUMsYUFBYSxPQUFPQyxNQUFQLEtBQWtCLFdBQWxCLEdBQWdDQyxNQUFoQyxHQUF5Q0QsTUFBNUQ7O0FBRUEsSUFBSUUsWUFBWSxZQUFXO0FBQ3pCLFNBQU9ILFdBQVdJLENBQWxCO0FBQ0QsQ0FGRDs7QUFJZSxNQUFNQyxpQkFBTixTQUFnQ0wsV0FBV00sS0FBM0MsQ0FBaUQ7QUFDOURDLGNBQVlDLFVBQVosRUFBd0JDLEtBQXhCLEVBQStCQyxRQUEvQixFQUF5QztBQUN2QztBQUNBLFFBQUlDLFdBQVdDLFdBQWYsRUFBNEI7QUFDMUIsVUFBSUosZUFBZSxDQUFuQixFQUNFLEtBQUtLLFFBQUwsQ0FBYztBQUNaQyxvQkFBWUo7QUFEQSxPQUFkO0FBR0YsV0FBS0csUUFBTCxDQUFjO0FBQ1pFLFlBQUksS0FBS0MsSUFBTCxFQURRO0FBRVpDLGVBQU8sRUFGSztBQUdaQyxrQkFBVSxJQUFJQyxHQUFKLEVBSEU7QUFJWkMscUJBQWEsS0FKRDtBQUtaQyxrQkFBVSxJQUFJQywwQkFBSixDQUFxQixJQUFyQixDQUxFO0FBTVpDLHFCQUFhLENBTkQ7QUFPWkMsZ0JBQVEsSUFBSUMsR0FBSixDQUFRakIsVUFBUixDQVBJO0FBUVprQixjQUFNLElBQUlDLE1BQUosQ0FBVyxDQUFYLEVBQWMsQ0FBQyxNQUFELEVBQVMsWUFB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QXhCLEVBQWdDO0FBQ2pELGNBQUk7QUFDRjtBQUNBLGdCQUFJVSxPQUFPLE1BQU1ELGNBQWNELE9BQWQsRUFBakI7QUFDQVQsb0JBQVFXLElBQVI7QUFDRCxXQUpELENBSUUsT0FBT0MsS0FBUCxFQUFjO0FBQ2RwQyxvQkFBUW9DLEtBQVIsQ0FBY0EsS0FBZDtBQUNBWCxtQkFBTyxJQUFJSixLQUFKLENBQVUsT0FBVixDQUFQO0FBQ0Q7QUFDRixTQVRNLENBQVA7QUFVRCxPQVpELENBWUUsT0FBT2UsS0FBUCxFQUFjO0FBQ2RwQyxnQkFBUW9DLEtBQVIsQ0FBY0EsS0FBZDtBQUNEO0FBQ0Y7QUFDRjs7QUFFREMsb0JBQWtCQyxJQUFsQixFQUF3QjtBQUN0QixRQUFJLE9BQU9BLElBQVAsSUFBZSxXQUFuQixFQUFnQztBQUM5QixXQUFLN0UsV0FBTCxDQUFpQlEsR0FBakIsQ0FBcUJxRSxJQUFyQjtBQUNBO0FBQ0Q7QUFDRCxRQUFJLEtBQUsvRSxRQUFMLENBQWM0QixNQUFkLEtBQXlCLENBQXpCLElBQThCLEtBQUt6QixRQUFMLENBQWM2RSxVQUFkLENBQXlCcEQsTUFBekIsS0FDaEMsQ0FERixFQUVFLEtBQUsxQixXQUFMLENBQWlCUSxHQUFqQixDQUFxQixLQUFyQjtBQUNIO0FBblA2RDs7a0JBQTNDdkIsaUI7QUFzUHJCUCxXQUFXcUcsZUFBWCxDQUEyQixDQUFDOUYsaUJBQUQsQ0FBM0IiLCJmaWxlIjoiQ29uZmlndXJhdGlvbk5vZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBzcGluYWxDb3JlID0gcmVxdWlyZShcInNwaW5hbC1jb3JlLWNvbm5lY3RvcmpzXCIpO1xuY29uc3QgZ2xvYmFsVHlwZSA9IHR5cGVvZiB3aW5kb3cgPT09IFwidW5kZWZpbmVkXCIgPyBnbG9iYWwgOiB3aW5kb3c7XG5pbXBvcnQgU3BpbmFsQklNR3JvdXBPQyBmcm9tIFwiLi9TcGluYWxCSU1Hcm91cE9DXCI7XG5sZXQgZ2V0Vmlld2VyID0gZnVuY3Rpb24oKSB7XG4gIHJldHVybiBnbG9iYWxUeXBlLnY7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb25maWd1cmF0aW9uTm9kZSBleHRlbmRzIGdsb2JhbFR5cGUuTW9kZWwge1xuICBjb25zdHJ1Y3RvcihfbmV3UGFyZW50LCBfdHlwZSwgX29wdGlvbnMpIHtcbiAgICBzdXBlcigpO1xuICAgIGlmIChGaWxlU3lzdGVtLl9zaWdfc2VydmVyKSB7XG4gICAgICBpZiAoX25ld1BhcmVudCA9PT0gMClcbiAgICAgICAgdGhpcy5hZGRfYXR0cih7XG4gICAgICAgICAgcmVsT3B0aW9uczogX29wdGlvbnNcbiAgICAgICAgfSk7XG4gICAgICB0aGlzLmFkZF9hdHRyKHtcbiAgICAgICAgaWQ6IHRoaXMuZ3VpZCgpLFxuICAgICAgICB0aXRsZTogXCJcIixcbiAgICAgICAgY2hpbGRyZW46IG5ldyBMc3QoKSxcbiAgICAgICAgc2hvd0NvbnRlbnQ6IGZhbHNlLFxuICAgICAgICBCSU1Hcm91cDogbmV3IFNwaW5hbEJJTUdyb3VwT0ModGhpcyksXG4gICAgICAgIGNoaWxkTmFtZUlkOiAwLFxuICAgICAgICBwYXJlbnQ6IG5ldyBQdHIoX25ld1BhcmVudCksXG4gICAgICAgIHR5cGU6IG5ldyBDaG9pY2UoMCwgW1wiWm9uZVwiLCBcIkVxdWlwZW1lbnRcIl0pXG4gICAgICB9KTtcbiAgICAgIHRoaXMudHlwZS5zZXQoX3R5cGUgfHwgXCJab25lXCIpO1xuICAgIH1cbiAgfVxuXG4gIC8vY29tbXVuIGZvciBhbGwgdHlwZXNcbiAgaW5jcmVtZW50Q2hpbGROYW1lSWQoKSB7XG4gICAgdGhpcy5jaGlsZE5hbWVJZC5zZXQodGhpcy5jaGlsZE5hbWVJZC5nZXQoKSArIDEpO1xuICAgIHJldHVybiB0aGlzLmNoaWxkTmFtZUlkLmdldCgpO1xuICB9XG5cbiAgZ3VpZCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIHRoaXMuczQoKVxuICAgICk7XG4gIH1cblxuICBzNCgpIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcigoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMClcbiAgICAgIC50b1N0cmluZygxNilcbiAgICAgIC5zdWJzdHJpbmcoMSk7XG4gIH1cblxuICBjcmVhdGVDaGlsZChfdHlwZSkge1xuICAgIGxldCBjaGlsZCA9IG5ldyBDb25maWd1cmF0aW9uTm9kZSh0aGlzLCBfdHlwZSk7XG5cbiAgICAvLyBjb25zb2xlLmxvZyhcInR5cGVcIiwgX3R5cGUpO1xuICAgIGlmIChfdHlwZSA9PT0gXCJab25lXCIpIHtcbiAgICAgIGxldCBwYXJlbnRUaXRsZSA9IHRoaXMudGl0bGUuZ2V0KCk7XG4gICAgICBjaGlsZC5zZXRUaXRsZShcbiAgICAgICAgcGFyZW50VGl0bGUgKyBcIi1cIiArIHRoaXMuaW5jcmVtZW50Q2hpbGROYW1lSWQoKS50b1N0cmluZygpXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAoX3R5cGUgPT09IFwiRXF1aXBlbWVudFwiKSB7XG4gICAgICBjaGlsZC5zZXRUaXRsZShcbiAgICAgICAgXCJFcXVpcGVtZW50XCIgKyBcIi1cIiArIHRoaXMuaW5jcmVtZW50Q2hpbGROYW1lSWQoKS50b1N0cmluZygpXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmFkZENoaWxkKGNoaWxkKTtcbiAgfVxuXG4gIGFkZENoaWxkKGNoaWxkLCBpbmRleCkge1xuICAgIGlmICh0eXBlb2YgaW5kZXggPT0gXCJ1bmRlZmluZWRcIikgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTtcbiAgICAvLyBlbHNlXG4gICAgLy8gICB0aGlzLmNoaWxkcmVuLnB1c2goKVxuICB9XG5cbiAgYWRkQ2hpbGRyZW4oY2hpbGRyZW4pIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGRyZW5baV0pO1xuICAgIH1cbiAgfVxuXG4gIGdldENoaWxkcmVuKCkge1xuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLmdldCgpO1xuICB9XG5cbiAgZ2V0VGl0bGUoKSB7XG4gICAgcmV0dXJuIHRoaXMudGl0bGUuZ2V0KCk7XG4gIH1cblxuICBzZXRUaXRsZSh0aXRsZSkge1xuICAgIHRoaXMudGl0bGUuc2V0KHRpdGxlKTtcbiAgfVxuXG4gIHJlbW92ZUNoaWxkcmVuKCkge1xuICAgIHRoaXMuY2hpbGRyZW4uc2V0KG51bGwpO1xuICB9XG5cbiAgaXNMZWFmKCkge1xuICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PSAwKSByZXR1cm4gdHJ1ZTtcbiAgICBlbHNlIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGlzRXF1aXBlbWVudCgpIHtcbiAgICByZXR1cm4gdGhpcy50eXBlLmdldCgpID09PSBcIkVxdWlwZW1lbnRcIjtcbiAgfVxuXG4gIGdldEVxdWlwZW1lbnRzKCkge1xuICAgIGxldCBlcXVpcGVtZW50c0FycmF5ID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBlcXVpcCA9IHRoaXMuY2hpbGRyZW5baV07XG4gICAgICAvLyBjb25zb2xlLmxvZyhcInJlY3VyXCIsIGVxdWlwLnR5cGUuZ2V0KCkpO1xuICAgICAgLy8gY29uc29sZS5sb2coZXF1aXBlbWVudHNBcnJheSk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhlcXVpcC5pc0VxdWlwZW1lbnQoKSk7XG4gICAgICBpZiAoZXF1aXAuaXNFcXVpcGVtZW50KCkpXG4gICAgICAgIGVxdWlwZW1lbnRzQXJyYXkgPSBlcXVpcGVtZW50c0FycmF5LmNvbmNhdChlcXVpcCk7XG4gICAgICBlbHNlIGVxdWlwZW1lbnRzQXJyYXkgPSBlcXVpcGVtZW50c0FycmF5LmNvbmNhdChlcXVpcC5nZXRFcXVpcGVtZW50cygpKTtcbiAgICB9XG4gICAgcmV0dXJuIGVxdWlwZW1lbnRzQXJyYXk7XG4gIH1cblxuICBnZXRBbGxCSU1Hcm91cHMoKSB7XG4gICAgbGV0IHJlcyA9IFtdO1xuICAgIHJlcy5wdXNoKHRoaXMuQklNR3JvdXApO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLmNoaWxkcmVuW2ldO1xuICAgICAgcmVzID0gcmVzLmNvbmNhdChjaGlsZC5nZXRBbGxCSU1Hcm91cHMoKSk7XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICB0ZXN0KCkge1xuICAgIGNvbnNvbGUubG9nKHRoaXMpO1xuICB9XG5cbiAgZ2V0SXRlbXMoKSB7XG4gICAgbGV0IHQgPSBbXTtcbiAgICB0ID0gdC5jb25jYXQodGhpcy5CSU1Hcm91cC5hcnJheU9mSWQoKSk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gdGhpcy5jaGlsZHJlbltpXTtcbiAgICAgIGxldCBjaGlsZEl0ZW1zID0gZWxlbWVudC5nZXRJdGVtcygpO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGlsZEl0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSBjaGlsZEl0ZW1zW2ldO1xuICAgICAgICBpZiAodC5pbmRleE9mKGVsZW1lbnQpID09PSAtMSkgdC5wdXNoKGVsZW1lbnQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdDtcbiAgfVxuXG4gIHNldEFsbERpc3BsYXlzKF9ib29sKSB7XG4gICAgbGV0IHQgPSB0aGlzLmdldEFsbEJJTUdyb3VwcygpO1xuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCB0Lmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgY29uc3QgZWxlbWVudCA9IHRbaW5kZXhdO1xuICAgICAgZWxlbWVudC5kaXNwbGF5LnNldChfYm9vbCk7XG4gICAgfVxuICB9XG5cbiAgc2V0QWxsRGF0YXNBY3RpdmUoX2Jvb2wpIHtcbiAgICBsZXQgdCA9IHRoaXMuZ2V0QWxsQklNR3JvdXBzKCk7XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHQubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gdFtpbmRleF07XG4gICAgICBlbGVtZW50LmFjdGl2ZS5zZXQoX2Jvb2wpO1xuICAgIH1cbiAgfVxuXG4gIHNldFBhcmVudChwYXJlbnQpIHtcbiAgICB0aGlzLnBhcmVudC5zZXQocGFyZW50KTtcbiAgfVxuXG4gIG1vZFBhcmVudChwYXJlbnQpIHtcbiAgICBpZiAodGhpcy5wYXJlbnQuY29uc3RydWN0b3IubmFtZSA9PT0gcGFyZW50LmNvbnN0cnVjdG9yLm5hbWUpXG4gICAgICB0aGlzLnBhcmVudC5zZXQocGFyZW50KTtcbiAgICBlbHNlIHtcbiAgICAgIHRoaXMubW9kX2F0dHIoXCJwYXJlbnRcIiwgcGFyZW50KTtcbiAgICAgIC8vIHRoaXMubW9kX2F0dHIoJ3BhcmVudCcsIHBhcmVudCk7XG4gICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLnBhcmVudC5jb25zdHJ1Y3Rvci5uYW1lKTtcbiAgICB9XG4gIH1cblxuICBnZXRQYXJlbnQoY2IsIHJlaikge1xuICAgIHRoaXMucGFyZW50LmxvYWQocGFyZW50ID0+IHtcbiAgICAgIGlmICh0eXBlb2YgY2IgIT0gXCJ1bmRlZmluZWRcIikgY2IocGFyZW50KTtcbiAgICAgIGVsc2UgcmVqKG5ldyBFcnJvcihcIlBhcmVudFwiKSlcbiAgICB9KTtcbiAgfVxuICBnZXRQYXJlbnRBc3luYygpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gY29uc29sZS5sb2codGhpcy5wYXJlbnQpO1xuICAgICAgdGhpcy5nZXRQYXJlbnQocmVzb2x2ZSwgcmVqZWN0KTtcbiAgICB9KTtcbiAgfVxuICByZW1vdmVQYXJlbnQoKSB7XG4gICAgLy8gdGhpcy5tb2RQYXJlbnQobmV3IGdsb2JhbFR5cGUuUHRyKDApKTtcbiAgICB0aGlzLnNldFBhcmVudCgwKTtcbiAgfVxuXG4gIHJlbW92ZSgpIHtcbiAgICBpZiAoIXRoaXMuaXNSb290KCkpIHtcbiAgICAgIHRoaXMuZ2V0UGFyZW50KHBhcmVudCA9PiB7XG4gICAgICAgIHBhcmVudC5jaGlsZHJlbi5yZW1vdmUodGhpcyk7XG4gICAgICAgIGRlbGV0ZSBnbG9iYWxUeXBlLkZpbGVTeXN0ZW0uX29iamVjdHNbdGhpcy5fc2VydmVyX2lkXTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGlzUm9vdCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5wYXJlbnQuY29uc3RydWN0b3IubmFtZSA9PT0gXCJQdHJcIiAmJiB0aGlzLnBhcmVudC5kYXRhLnZhbHVlID09PVxuICAgICAgMFxuICAgICk7XG4gIH1cblxuICBhc3luYyBnZXRSb290KCkge1xuICAgIGlmICh0aGlzLmlzUm9vdCgpKSB7XG4gICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICByZXNvbHZlKHRoaXMpO1xuICAgICAgICAvLyByZWplY3QobmV3IEVycm9yKFwiZmFpbFwiKSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IHJvb3RDYW5kaWRhdGUgPSBhd2FpdCB0aGlzLmdldFBhcmVudEFzeW5jKCk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2cocm9vdENhbmRpZGF0ZS50aXRsZS5nZXQoKSk7XG4gICAgICAgICAgICBsZXQgcm9vdCA9IGF3YWl0IHJvb3RDYW5kaWRhdGUuZ2V0Um9vdCgpO1xuICAgICAgICAgICAgcmVzb2x2ZShyb290KTtcbiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgICAgICByZWplY3QobmV3IEVycm9yKFwiRXJyb3JcIikpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB1cGRhdGVTaG93Q29udGVudChib29sKSB7XG4gICAgaWYgKHR5cGVvZiBib29sICE9IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIHRoaXMuc2hvd0NvbnRlbnQuc2V0KGJvb2wpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDAgJiYgdGhpcy5CSU1Hcm91cC5CSU1PYmplY3RzLmxlbmd0aCA9PT1cbiAgICAgIDApXG4gICAgICB0aGlzLnNob3dDb250ZW50LnNldChmYWxzZSk7XG4gIH1cbn1cblxuc3BpbmFsQ29yZS5yZWdpc3Rlcl9tb2RlbHMoW0NvbmZpZ3VyYXRpb25Ob2RlXSk7Il19