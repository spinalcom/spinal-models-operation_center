"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _SpinalBIMGroupOC = require("./SpinalBIMGroupOC");

var _SpinalBIMGroupOC2 = _interopRequireDefault(_SpinalBIMGroupOC);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const spinalCore = require("spinal-core-connectorjs");
const globalType = typeof window === "undefined" ? global : window;

let getViewer = function () {
  return globalType.v;
};

class ConfigurationNode extends globalType.Model {
  constructor(_newParent, _type, _options) {
    super();
    if (FileSystem._sig_server) {
      if (_newParent === 0) this.add_attr({
        relOptions: _options
      });
      this.add_attr({
        id: this.guid(),
        title: "",
        children: new Lst(),
        showContent: false,
        BIMGroup: new _SpinalBIMGroupOC2.default(this),
        childNameId: 0,
        parent: new Ptr(_newParent),
        type: new Choice(0, ["Zone", "Equipement"])
      });
      this.type.set(_type || "Zone");
    }
  }

  //commun for all types
  incrementChildNameId() {
    this.childNameId.set(this.childNameId.get() + 1);
    return this.childNameId.get();
  }

  guid() {
    return this.constructor.name + "-" + this.s4() + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + this.s4() + this.s4() + "-" + Date.now().toString(16);
  }

  s4() {
    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
  }

  createChild(_type) {
    let child = new ConfigurationNode(this, _type);

    // console.log("type", _type);
    if (_type === "Zone") {
      let parentTitle = this.title.get();
      child.setTitle(parentTitle + "-" + this.incrementChildNameId().toString());
    } else if (_type === "Equipement") {
      child.setTitle("Equipement" + "-" + this.incrementChildNameId().toString());
    }
    this.addChild(child);
  }

  addChild(child, index) {
    if (typeof index == "undefined") this.children.push(child);
    // else
    //   this.children.push()
  }

  addChildren(children) {
    for (let i = 0; i < children.length; i++) {
      this.children.push(children[i]);
    }
  }

  getChildren() {
    return this.children.get();
  }

  getTitle() {
    return this.title.get();
  }

  setTitle(title) {
    this.title.set(title);
  }

  removeChildren() {
    this.children.set(null);
  }

  isLeaf() {
    if (this.children.length == 0) return true;else return false;
  }

  isEquipement() {
    return this.type.get() === "Equipement";
  }

  getEquipements() {
    let equipementsArray = [];
    for (let i = 0; i < this.children.length; i++) {
      const equip = this.children[i];
      // console.log("recur", equip.type.get());
      // console.log(equipementsArray);
      // console.log(equip.isEquipement());
      if (equip.isEquipement()) equipementsArray = equipementsArray.concat(equip);else equipementsArray = equipementsArray.concat(equip.getEquipements());
    }
    return equipementsArray;
  }

  getAllBIMGroups() {
    let res = [];
    res.push(this.BIMGroup);
    for (let i = 0; i < this.children.length; i++) {
      const child = this.children[i];
      res = res.concat(child.getAllBIMGroups());
    }
    return res;
  }

  test() {
    console.log(this);
  }

  getItems() {
    let t = [];
    t = t.concat(this.BIMGroup.arrayOfId());
    for (let i = 0; i < this.children.length; i++) {
      const element = this.children[i];
      let childItems = element.getItems();
      for (let i = 0; i < childItems.length; i++) {
        const element = childItems[i];
        if (t.indexOf(element) === -1) t.push(element);
      }
    }
    return t;
  }

  setAllDisplays(_bool) {
    let t = this.getAllBIMGroups();
    for (let index = 0; index < t.length; index++) {
      const element = t[index];
      element.display.set(_bool);
    }
  }

  setAllDatasActive(_bool) {
    let t = this.getAllBIMGroups();
    for (let index = 0; index < t.length; index++) {
      const element = t[index];
      element.active.set(_bool);
    }
  }

  setParent(parent) {
    this.parent.set(parent);
  }

  modParent(parent) {
    if (this.parent.constructor.name === parent.constructor.name) this.parent.set(parent);else {
      this.mod_attr("parent", parent);
      // this.mod_attr('parent', parent);
      // console.log(this.parent.constructor.name);
    }
  }

  getParent(cb, rej) {
    this.parent.load(parent => {
      if (typeof cb != "undefined") cb(parent);else rej(new Error("Parent"));
    });
  }
  getParentAsync() {
    return new Promise((resolve, reject) => {
      // console.log(this.parent);
      this.getParent(resolve, reject);
    });
  }
  removeParent() {
    // this.modParent(new globalType.Ptr(0));
    this.setParent(0);
  }

  remove() {
    if (!this.isRoot()) {
      this.getParent(parent => {
        parent.children.remove(this);
        delete globalType.FileSystem._objects[this._server_id];
      });
    }
  }

  isRoot() {
    return this.parent.constructor.name === "Ptr" && this.parent.data.value === 0;
  }

  async getRoot() {
    if (this.isRoot()) {
      return new Promise((resolve, reject) => {
        resolve(this);
        // reject(new Error("fail"));
      });
    } else {
      try {
        let rootCandidate = await this.getParentAsync();
        return new Promise(async function (resolve, reject) {
          try {
            // console.log(rootCandidate.title.get());
            let root = await rootCandidate.getRoot();
            resolve(root);
          } catch (error) {
            console.error(error);
            reject(new Error("Error"));
          }
        });
      } catch (error) {
        console.error(error);
      }
    }
  }

  updateShowContent(bool) {
    if (typeof bool != "undefined") {
      this.showContent.set(bool);
      return;
    }
    if (this.children.length === 0 && this.BIMGroup.BIMObjects.length === 0) this.showContent.set(false);
  }
}

exports.default = ConfigurationNode;
spinalCore.register_models([ConfigurationNode]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Db25maWd1cmF0aW9uTm9kZS5qcyJdLCJuYW1lcyI6WyJzcGluYWxDb3JlIiwicmVxdWlyZSIsImdsb2JhbFR5cGUiLCJ3aW5kb3ciLCJnbG9iYWwiLCJnZXRWaWV3ZXIiLCJ2IiwiQ29uZmlndXJhdGlvbk5vZGUiLCJNb2RlbCIsImNvbnN0cnVjdG9yIiwiX25ld1BhcmVudCIsIl90eXBlIiwiX29wdGlvbnMiLCJGaWxlU3lzdGVtIiwiX3NpZ19zZXJ2ZXIiLCJhZGRfYXR0ciIsInJlbE9wdGlvbnMiLCJpZCIsImd1aWQiLCJ0aXRsZSIsImNoaWxkcmVuIiwiTHN0Iiwic2hvd0NvbnRlbnQiLCJCSU1Hcm91cCIsIlNwaW5hbEJJTUdyb3VwT0MiLCJjaGlsZE5hbWVJZCIsInBhcmVudCIsIlB0ciIsInR5cGUiLCJDaG9pY2UiLCJzZXQiLCJpbmNyZW1lbnRDaGlsZE5hbWVJZCIsImdldCIsIm5hbWUiLCJzNCIsIkRhdGUiLCJub3ciLCJ0b1N0cmluZyIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsInN1YnN0cmluZyIsImNyZWF0ZUNoaWxkIiwiY2hpbGQiLCJwYXJlbnRUaXRsZSIsInNldFRpdGxlIiwiYWRkQ2hpbGQiLCJpbmRleCIsInB1c2giLCJhZGRDaGlsZHJlbiIsImkiLCJsZW5ndGgiLCJnZXRDaGlsZHJlbiIsImdldFRpdGxlIiwicmVtb3ZlQ2hpbGRyZW4iLCJpc0xlYWYiLCJpc0VxdWlwZW1lbnQiLCJnZXRFcXVpcGVtZW50cyIsImVxdWlwZW1lbnRzQXJyYXkiLCJlcXVpcCIsImNvbmNhdCIsImdldEFsbEJJTUdyb3VwcyIsInJlcyIsInRlc3QiLCJjb25zb2xlIiwibG9nIiwiZ2V0SXRlbXMiLCJ0IiwiYXJyYXlPZklkIiwiZWxlbWVudCIsImNoaWxkSXRlbXMiLCJpbmRleE9mIiwic2V0QWxsRGlzcGxheXMiLCJfYm9vbCIsImRpc3BsYXkiLCJzZXRBbGxEYXRhc0FjdGl2ZSIsImFjdGl2ZSIsInNldFBhcmVudCIsIm1vZFBhcmVudCIsIm1vZF9hdHRyIiwiZ2V0UGFyZW50IiwiY2IiLCJyZWoiLCJsb2FkIiwiRXJyb3IiLCJnZXRQYXJlbnRBc3luYyIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwicmVtb3ZlUGFyZW50IiwicmVtb3ZlIiwiaXNSb290IiwiX29iamVjdHMiLCJfc2VydmVyX2lkIiwiZGF0YSIsInZhbHVlIiwiZ2V0Um9vdCIsInJvb3RDYW5kaWRhdGUiLCJyb290IiwiZXJyb3IiLCJ1cGRhdGVTaG93Q29udGVudCIsImJvb2wiLCJCSU1PYmplY3RzIiwicmVnaXN0ZXJfbW9kZWxzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQTs7Ozs7O0FBRkEsTUFBTUEsYUFBYUMsUUFBUSx5QkFBUixDQUFuQjtBQUNBLE1BQU1DLGFBQWEsT0FBT0MsTUFBUCxLQUFrQixXQUFsQixHQUFnQ0MsTUFBaEMsR0FBeUNELE1BQTVEOztBQUVBLElBQUlFLFlBQVksWUFBVztBQUN6QixTQUFPSCxXQUFXSSxDQUFsQjtBQUNELENBRkQ7O0FBSWUsTUFBTUMsaUJBQU4sU0FBZ0NMLFdBQVdNLEtBQTNDLENBQWlEO0FBQzlEQyxjQUFZQyxVQUFaLEVBQXdCQyxLQUF4QixFQUErQkMsUUFBL0IsRUFBeUM7QUFDdkM7QUFDQSxRQUFJQyxXQUFXQyxXQUFmLEVBQTRCO0FBQzFCLFVBQUlKLGVBQWUsQ0FBbkIsRUFDRSxLQUFLSyxRQUFMLENBQWM7QUFDWkMsb0JBQVlKO0FBREEsT0FBZDtBQUdGLFdBQUtHLFFBQUwsQ0FBYztBQUNaRSxZQUFJLEtBQUtDLElBQUwsRUFEUTtBQUVaQyxlQUFPLEVBRks7QUFHWkMsa0JBQVUsSUFBSUMsR0FBSixFQUhFO0FBSVpDLHFCQUFhLEtBSkQ7QUFLWkMsa0JBQVUsSUFBSUMsMEJBQUosQ0FBcUIsSUFBckIsQ0FMRTtBQU1aQyxxQkFBYSxDQU5EO0FBT1pDLGdCQUFRLElBQUlDLEdBQUosQ0FBUWpCLFVBQVIsQ0FQSTtBQVFaa0IsY0FBTSxJQUFJQyxNQUFKLENBQVcsQ0FBWCxFQUFjLENBQUMsTUFBRCxFQUFTLFlBQVQsQ0FBZDtBQVJNLE9BQWQ7QUFVQSxXQUFLRCxJQUFMLENBQVVFLEdBQVYsQ0FBY25CLFNBQVMsTUFBdkI7QUFDRDtBQUNGOztBQUVEO0FBQ0FvQix5QkFBdUI7QUFDckIsU0FBS04sV0FBTCxDQUFpQkssR0FBakIsQ0FBcUIsS0FBS0wsV0FBTCxDQUFpQk8sR0FBakIsS0FBeUIsQ0FBOUM7QUFDQSxXQUFPLEtBQUtQLFdBQUwsQ0FBaUJPLEdBQWpCLEVBQVA7QUFDRDs7QUFFRGQsU0FBTztBQUNMLFdBQ0UsS0FBS1QsV0FBTCxDQUFpQndCLElBQWpCLEdBQ0EsR0FEQSxHQUVBLEtBQUtDLEVBQUwsRUFGQSxHQUdBLEtBQUtBLEVBQUwsRUFIQSxHQUlBLEdBSkEsR0FLQSxLQUFLQSxFQUFMLEVBTEEsR0FNQSxHQU5BLEdBT0EsS0FBS0EsRUFBTCxFQVBBLEdBUUEsR0FSQSxHQVNBLEtBQUtBLEVBQUwsRUFUQSxHQVVBLEdBVkEsR0FXQSxLQUFLQSxFQUFMLEVBWEEsR0FZQSxLQUFLQSxFQUFMLEVBWkEsR0FhQSxLQUFLQSxFQUFMLEVBYkEsR0FjQSxHQWRBLEdBZUFDLEtBQUtDLEdBQUwsR0FBV0MsUUFBWCxDQUFvQixFQUFwQixDQWhCRjtBQWtCRDs7QUFFREgsT0FBSztBQUNILFdBQU9JLEtBQUtDLEtBQUwsQ0FBVyxDQUFDLElBQUlELEtBQUtFLE1BQUwsRUFBTCxJQUFzQixPQUFqQyxFQUNKSCxRQURJLENBQ0ssRUFETCxFQUVKSSxTQUZJLENBRU0sQ0FGTixDQUFQO0FBR0Q7O0FBRURDLGNBQVkvQixLQUFaLEVBQW1CO0FBQ2pCLFFBQUlnQyxRQUFRLElBQUlwQyxpQkFBSixDQUFzQixJQUF0QixFQUE0QkksS0FBNUIsQ0FBWjs7QUFFQTtBQUNBLFFBQUlBLFVBQVUsTUFBZCxFQUFzQjtBQUNwQixVQUFJaUMsY0FBYyxLQUFLekIsS0FBTCxDQUFXYSxHQUFYLEVBQWxCO0FBQ0FXLFlBQU1FLFFBQU4sQ0FDRUQsY0FBYyxHQUFkLEdBQW9CLEtBQUtiLG9CQUFMLEdBQTRCTSxRQUE1QixFQUR0QjtBQUdELEtBTEQsTUFLTyxJQUFJMUIsVUFBVSxZQUFkLEVBQTRCO0FBQ2pDZ0MsWUFBTUUsUUFBTixDQUNFLGVBQWUsR0FBZixHQUFxQixLQUFLZCxvQkFBTCxHQUE0Qk0sUUFBNUIsRUFEdkI7QUFHRDtBQUNELFNBQUtTLFFBQUwsQ0FBY0gsS0FBZDtBQUNEOztBQUVERyxXQUFTSCxLQUFULEVBQWdCSSxLQUFoQixFQUF1QjtBQUNyQixRQUFJLE9BQU9BLEtBQVAsSUFBZ0IsV0FBcEIsRUFBaUMsS0FBSzNCLFFBQUwsQ0FBYzRCLElBQWQsQ0FBbUJMLEtBQW5CO0FBQ2pDO0FBQ0E7QUFDRDs7QUFFRE0sY0FBWTdCLFFBQVosRUFBc0I7QUFDcEIsU0FBSyxJQUFJOEIsSUFBSSxDQUFiLEVBQWdCQSxJQUFJOUIsU0FBUytCLE1BQTdCLEVBQXFDRCxHQUFyQyxFQUEwQztBQUN4QyxXQUFLOUIsUUFBTCxDQUFjNEIsSUFBZCxDQUFtQjVCLFNBQVM4QixDQUFULENBQW5CO0FBQ0Q7QUFDRjs7QUFFREUsZ0JBQWM7QUFDWixXQUFPLEtBQUtoQyxRQUFMLENBQWNZLEdBQWQsRUFBUDtBQUNEOztBQUVEcUIsYUFBVztBQUNULFdBQU8sS0FBS2xDLEtBQUwsQ0FBV2EsR0FBWCxFQUFQO0FBQ0Q7O0FBRURhLFdBQVMxQixLQUFULEVBQWdCO0FBQ2QsU0FBS0EsS0FBTCxDQUFXVyxHQUFYLENBQWVYLEtBQWY7QUFDRDs7QUFFRG1DLG1CQUFpQjtBQUNmLFNBQUtsQyxRQUFMLENBQWNVLEdBQWQsQ0FBa0IsSUFBbEI7QUFDRDs7QUFFRHlCLFdBQVM7QUFDUCxRQUFJLEtBQUtuQyxRQUFMLENBQWMrQixNQUFkLElBQXdCLENBQTVCLEVBQStCLE9BQU8sSUFBUCxDQUEvQixLQUNLLE9BQU8sS0FBUDtBQUNOOztBQUVESyxpQkFBZTtBQUNiLFdBQU8sS0FBSzVCLElBQUwsQ0FBVUksR0FBVixPQUFvQixZQUEzQjtBQUNEOztBQUVEeUIsbUJBQWlCO0FBQ2YsUUFBSUMsbUJBQW1CLEVBQXZCO0FBQ0EsU0FBSyxJQUFJUixJQUFJLENBQWIsRUFBZ0JBLElBQUksS0FBSzlCLFFBQUwsQ0FBYytCLE1BQWxDLEVBQTBDRCxHQUExQyxFQUErQztBQUM3QyxZQUFNUyxRQUFRLEtBQUt2QyxRQUFMLENBQWM4QixDQUFkLENBQWQ7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFJUyxNQUFNSCxZQUFOLEVBQUosRUFDRUUsbUJBQW1CQSxpQkFBaUJFLE1BQWpCLENBQXdCRCxLQUF4QixDQUFuQixDQURGLEtBRUtELG1CQUFtQkEsaUJBQWlCRSxNQUFqQixDQUF3QkQsTUFBTUYsY0FBTixFQUF4QixDQUFuQjtBQUNOO0FBQ0QsV0FBT0MsZ0JBQVA7QUFDRDs7QUFFREcsb0JBQWtCO0FBQ2hCLFFBQUlDLE1BQU0sRUFBVjtBQUNBQSxRQUFJZCxJQUFKLENBQVMsS0FBS3pCLFFBQWQ7QUFDQSxTQUFLLElBQUkyQixJQUFJLENBQWIsRUFBZ0JBLElBQUksS0FBSzlCLFFBQUwsQ0FBYytCLE1BQWxDLEVBQTBDRCxHQUExQyxFQUErQztBQUM3QyxZQUFNUCxRQUFRLEtBQUt2QixRQUFMLENBQWM4QixDQUFkLENBQWQ7QUFDQVksWUFBTUEsSUFBSUYsTUFBSixDQUFXakIsTUFBTWtCLGVBQU4sRUFBWCxDQUFOO0FBQ0Q7QUFDRCxXQUFPQyxHQUFQO0FBQ0Q7O0FBRURDLFNBQU87QUFDTEMsWUFBUUMsR0FBUixDQUFZLElBQVo7QUFDRDs7QUFFREMsYUFBVztBQUNULFFBQUlDLElBQUksRUFBUjtBQUNBQSxRQUFJQSxFQUFFUCxNQUFGLENBQVMsS0FBS3JDLFFBQUwsQ0FBYzZDLFNBQWQsRUFBVCxDQUFKO0FBQ0EsU0FBSyxJQUFJbEIsSUFBSSxDQUFiLEVBQWdCQSxJQUFJLEtBQUs5QixRQUFMLENBQWMrQixNQUFsQyxFQUEwQ0QsR0FBMUMsRUFBK0M7QUFDN0MsWUFBTW1CLFVBQVUsS0FBS2pELFFBQUwsQ0FBYzhCLENBQWQsQ0FBaEI7QUFDQSxVQUFJb0IsYUFBYUQsUUFBUUgsUUFBUixFQUFqQjtBQUNBLFdBQUssSUFBSWhCLElBQUksQ0FBYixFQUFnQkEsSUFBSW9CLFdBQVduQixNQUEvQixFQUF1Q0QsR0FBdkMsRUFBNEM7QUFDMUMsY0FBTW1CLFVBQVVDLFdBQVdwQixDQUFYLENBQWhCO0FBQ0EsWUFBSWlCLEVBQUVJLE9BQUYsQ0FBVUYsT0FBVixNQUF1QixDQUFDLENBQTVCLEVBQStCRixFQUFFbkIsSUFBRixDQUFPcUIsT0FBUDtBQUNoQztBQUNGO0FBQ0QsV0FBT0YsQ0FBUDtBQUNEOztBQUVESyxpQkFBZUMsS0FBZixFQUFzQjtBQUNwQixRQUFJTixJQUFJLEtBQUtOLGVBQUwsRUFBUjtBQUNBLFNBQUssSUFBSWQsUUFBUSxDQUFqQixFQUFvQkEsUUFBUW9CLEVBQUVoQixNQUE5QixFQUFzQ0osT0FBdEMsRUFBK0M7QUFDN0MsWUFBTXNCLFVBQVVGLEVBQUVwQixLQUFGLENBQWhCO0FBQ0FzQixjQUFRSyxPQUFSLENBQWdCNUMsR0FBaEIsQ0FBb0IyQyxLQUFwQjtBQUNEO0FBQ0Y7O0FBRURFLG9CQUFrQkYsS0FBbEIsRUFBeUI7QUFDdkIsUUFBSU4sSUFBSSxLQUFLTixlQUFMLEVBQVI7QUFDQSxTQUFLLElBQUlkLFFBQVEsQ0FBakIsRUFBb0JBLFFBQVFvQixFQUFFaEIsTUFBOUIsRUFBc0NKLE9BQXRDLEVBQStDO0FBQzdDLFlBQU1zQixVQUFVRixFQUFFcEIsS0FBRixDQUFoQjtBQUNBc0IsY0FBUU8sTUFBUixDQUFlOUMsR0FBZixDQUFtQjJDLEtBQW5CO0FBQ0Q7QUFDRjs7QUFFREksWUFBVW5ELE1BQVYsRUFBa0I7QUFDaEIsU0FBS0EsTUFBTCxDQUFZSSxHQUFaLENBQWdCSixNQUFoQjtBQUNEOztBQUVEb0QsWUFBVXBELE1BQVYsRUFBa0I7QUFDaEIsUUFBSSxLQUFLQSxNQUFMLENBQVlqQixXQUFaLENBQXdCd0IsSUFBeEIsS0FBaUNQLE9BQU9qQixXQUFQLENBQW1Cd0IsSUFBeEQsRUFDRSxLQUFLUCxNQUFMLENBQVlJLEdBQVosQ0FBZ0JKLE1BQWhCLEVBREYsS0FFSztBQUNILFdBQUtxRCxRQUFMLENBQWMsUUFBZCxFQUF3QnJELE1BQXhCO0FBQ0E7QUFDQTtBQUNEO0FBQ0Y7O0FBRURzRCxZQUFVQyxFQUFWLEVBQWNDLEdBQWQsRUFBbUI7QUFDakIsU0FBS3hELE1BQUwsQ0FBWXlELElBQVosQ0FBaUJ6RCxVQUFVO0FBQ3pCLFVBQUksT0FBT3VELEVBQVAsSUFBYSxXQUFqQixFQUE4QkEsR0FBR3ZELE1BQUgsRUFBOUIsS0FDS3dELElBQUksSUFBSUUsS0FBSixDQUFVLFFBQVYsQ0FBSjtBQUNOLEtBSEQ7QUFJRDtBQUNEQyxtQkFBaUI7QUFDZixXQUFPLElBQUlDLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdEM7QUFDQSxXQUFLUixTQUFMLENBQWVPLE9BQWYsRUFBd0JDLE1BQXhCO0FBQ0QsS0FITSxDQUFQO0FBSUQ7QUFDREMsaUJBQWU7QUFDYjtBQUNBLFNBQUtaLFNBQUwsQ0FBZSxDQUFmO0FBQ0Q7O0FBRURhLFdBQVM7QUFDUCxRQUFJLENBQUMsS0FBS0MsTUFBTCxFQUFMLEVBQW9CO0FBQ2xCLFdBQUtYLFNBQUwsQ0FBZXRELFVBQVU7QUFDdkJBLGVBQU9OLFFBQVAsQ0FBZ0JzRSxNQUFoQixDQUF1QixJQUF2QjtBQUNBLGVBQU94RixXQUFXVyxVQUFYLENBQXNCK0UsUUFBdEIsQ0FBK0IsS0FBS0MsVUFBcEMsQ0FBUDtBQUNELE9BSEQ7QUFJRDtBQUNGOztBQUVERixXQUFTO0FBQ1AsV0FDRSxLQUFLakUsTUFBTCxDQUFZakIsV0FBWixDQUF3QndCLElBQXhCLEtBQWlDLEtBQWpDLElBQTBDLEtBQUtQLE1BQUwsQ0FBWW9FLElBQVosQ0FBaUJDLEtBQWpCLEtBQzFDLENBRkY7QUFJRDs7QUFFRCxRQUFNQyxPQUFOLEdBQWdCO0FBQ2QsUUFBSSxLQUFLTCxNQUFMLEVBQUosRUFBbUI7QUFDakIsYUFBTyxJQUFJTCxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDRCxnQkFBUSxJQUFSO0FBQ0E7QUFDRCxPQUhNLENBQVA7QUFJRCxLQUxELE1BS087QUFDTCxVQUFJO0FBQ0YsWUFBSVUsZ0JBQWdCLE1BQU0sS0FBS1osY0FBTCxFQUExQjtBQUNBLGVBQU8sSUFBSUMsT0FBSixDQUFZLGdCQUFlQyxPQUFmLEVBQXdCQyxNQUF4QixFQUFnQztBQUNqRCxjQUFJO0FBQ0Y7QUFDQSxnQkFBSVUsT0FBTyxNQUFNRCxjQUFjRCxPQUFkLEVBQWpCO0FBQ0FULG9CQUFRVyxJQUFSO0FBQ0QsV0FKRCxDQUlFLE9BQU9DLEtBQVAsRUFBYztBQUNkbkMsb0JBQVFtQyxLQUFSLENBQWNBLEtBQWQ7QUFDQVgsbUJBQU8sSUFBSUosS0FBSixDQUFVLE9BQVYsQ0FBUDtBQUNEO0FBQ0YsU0FUTSxDQUFQO0FBVUQsT0FaRCxDQVlFLE9BQU9lLEtBQVAsRUFBYztBQUNkbkMsZ0JBQVFtQyxLQUFSLENBQWNBLEtBQWQ7QUFDRDtBQUNGO0FBQ0Y7O0FBRURDLG9CQUFrQkMsSUFBbEIsRUFBd0I7QUFDdEIsUUFBSSxPQUFPQSxJQUFQLElBQWUsV0FBbkIsRUFBZ0M7QUFDOUIsV0FBSy9FLFdBQUwsQ0FBaUJRLEdBQWpCLENBQXFCdUUsSUFBckI7QUFDQTtBQUNEO0FBQ0QsUUFBSSxLQUFLakYsUUFBTCxDQUFjK0IsTUFBZCxLQUF5QixDQUF6QixJQUE4QixLQUFLNUIsUUFBTCxDQUFjK0UsVUFBZCxDQUF5Qm5ELE1BQXpCLEtBQ2hDLENBREYsRUFFRSxLQUFLN0IsV0FBTCxDQUFpQlEsR0FBakIsQ0FBcUIsS0FBckI7QUFDSDtBQXZQNkQ7O2tCQUEzQ3ZCLGlCO0FBMFByQlAsV0FBV3VHLGVBQVgsQ0FBMkIsQ0FBQ2hHLGlCQUFELENBQTNCIiwiZmlsZSI6IkNvbmZpZ3VyYXRpb25Ob2RlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgc3BpbmFsQ29yZSA9IHJlcXVpcmUoXCJzcGluYWwtY29yZS1jb25uZWN0b3Jqc1wiKTtcbmNvbnN0IGdsb2JhbFR5cGUgPSB0eXBlb2Ygd2luZG93ID09PSBcInVuZGVmaW5lZFwiID8gZ2xvYmFsIDogd2luZG93O1xuaW1wb3J0IFNwaW5hbEJJTUdyb3VwT0MgZnJvbSBcIi4vU3BpbmFsQklNR3JvdXBPQ1wiO1xubGV0IGdldFZpZXdlciA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gZ2xvYmFsVHlwZS52O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29uZmlndXJhdGlvbk5vZGUgZXh0ZW5kcyBnbG9iYWxUeXBlLk1vZGVsIHtcbiAgY29uc3RydWN0b3IoX25ld1BhcmVudCwgX3R5cGUsIF9vcHRpb25zKSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAoRmlsZVN5c3RlbS5fc2lnX3NlcnZlcikge1xuICAgICAgaWYgKF9uZXdQYXJlbnQgPT09IDApXG4gICAgICAgIHRoaXMuYWRkX2F0dHIoe1xuICAgICAgICAgIHJlbE9wdGlvbnM6IF9vcHRpb25zXG4gICAgICAgIH0pO1xuICAgICAgdGhpcy5hZGRfYXR0cih7XG4gICAgICAgIGlkOiB0aGlzLmd1aWQoKSxcbiAgICAgICAgdGl0bGU6IFwiXCIsXG4gICAgICAgIGNoaWxkcmVuOiBuZXcgTHN0KCksXG4gICAgICAgIHNob3dDb250ZW50OiBmYWxzZSxcbiAgICAgICAgQklNR3JvdXA6IG5ldyBTcGluYWxCSU1Hcm91cE9DKHRoaXMpLFxuICAgICAgICBjaGlsZE5hbWVJZDogMCxcbiAgICAgICAgcGFyZW50OiBuZXcgUHRyKF9uZXdQYXJlbnQpLFxuICAgICAgICB0eXBlOiBuZXcgQ2hvaWNlKDAsIFtcIlpvbmVcIiwgXCJFcXVpcGVtZW50XCJdKVxuICAgICAgfSk7XG4gICAgICB0aGlzLnR5cGUuc2V0KF90eXBlIHx8IFwiWm9uZVwiKTtcbiAgICB9XG4gIH1cblxuICAvL2NvbW11biBmb3IgYWxsIHR5cGVzXG4gIGluY3JlbWVudENoaWxkTmFtZUlkKCkge1xuICAgIHRoaXMuY2hpbGROYW1lSWQuc2V0KHRoaXMuY2hpbGROYW1lSWQuZ2V0KCkgKyAxKTtcbiAgICByZXR1cm4gdGhpcy5jaGlsZE5hbWVJZC5nZXQoKTtcbiAgfVxuXG4gIGd1aWQoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuY29uc3RydWN0b3IubmFtZSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIFwiLVwiICtcbiAgICAgIERhdGUubm93KCkudG9TdHJpbmcoMTYpXG4gICAgKTtcbiAgfVxuXG4gIHM0KCkge1xuICAgIHJldHVybiBNYXRoLmZsb29yKCgxICsgTWF0aC5yYW5kb20oKSkgKiAweDEwMDAwKVxuICAgICAgLnRvU3RyaW5nKDE2KVxuICAgICAgLnN1YnN0cmluZygxKTtcbiAgfVxuXG4gIGNyZWF0ZUNoaWxkKF90eXBlKSB7XG4gICAgbGV0IGNoaWxkID0gbmV3IENvbmZpZ3VyYXRpb25Ob2RlKHRoaXMsIF90eXBlKTtcblxuICAgIC8vIGNvbnNvbGUubG9nKFwidHlwZVwiLCBfdHlwZSk7XG4gICAgaWYgKF90eXBlID09PSBcIlpvbmVcIikge1xuICAgICAgbGV0IHBhcmVudFRpdGxlID0gdGhpcy50aXRsZS5nZXQoKTtcbiAgICAgIGNoaWxkLnNldFRpdGxlKFxuICAgICAgICBwYXJlbnRUaXRsZSArIFwiLVwiICsgdGhpcy5pbmNyZW1lbnRDaGlsZE5hbWVJZCgpLnRvU3RyaW5nKClcbiAgICAgICk7XG4gICAgfSBlbHNlIGlmIChfdHlwZSA9PT0gXCJFcXVpcGVtZW50XCIpIHtcbiAgICAgIGNoaWxkLnNldFRpdGxlKFxuICAgICAgICBcIkVxdWlwZW1lbnRcIiArIFwiLVwiICsgdGhpcy5pbmNyZW1lbnRDaGlsZE5hbWVJZCgpLnRvU3RyaW5nKClcbiAgICAgICk7XG4gICAgfVxuICAgIHRoaXMuYWRkQ2hpbGQoY2hpbGQpO1xuICB9XG5cbiAgYWRkQ2hpbGQoY2hpbGQsIGluZGV4KSB7XG4gICAgaWYgKHR5cGVvZiBpbmRleCA9PSBcInVuZGVmaW5lZFwiKSB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpO1xuICAgIC8vIGVsc2VcbiAgICAvLyAgIHRoaXMuY2hpbGRyZW4ucHVzaCgpXG4gIH1cblxuICBhZGRDaGlsZHJlbihjaGlsZHJlbikge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZHJlbltpXSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q2hpbGRyZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMuY2hpbGRyZW4uZ2V0KCk7XG4gIH1cblxuICBnZXRUaXRsZSgpIHtcbiAgICByZXR1cm4gdGhpcy50aXRsZS5nZXQoKTtcbiAgfVxuXG4gIHNldFRpdGxlKHRpdGxlKSB7XG4gICAgdGhpcy50aXRsZS5zZXQodGl0bGUpO1xuICB9XG5cbiAgcmVtb3ZlQ2hpbGRyZW4oKSB7XG4gICAgdGhpcy5jaGlsZHJlbi5zZXQobnVsbCk7XG4gIH1cblxuICBpc0xlYWYoKSB7XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoID09IDApIHJldHVybiB0cnVlO1xuICAgIGVsc2UgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaXNFcXVpcGVtZW50KCkge1xuICAgIHJldHVybiB0aGlzLnR5cGUuZ2V0KCkgPT09IFwiRXF1aXBlbWVudFwiO1xuICB9XG5cbiAgZ2V0RXF1aXBlbWVudHMoKSB7XG4gICAgbGV0IGVxdWlwZW1lbnRzQXJyYXkgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGVxdWlwID0gdGhpcy5jaGlsZHJlbltpXTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKFwicmVjdXJcIiwgZXF1aXAudHlwZS5nZXQoKSk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhlcXVpcGVtZW50c0FycmF5KTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGVxdWlwLmlzRXF1aXBlbWVudCgpKTtcbiAgICAgIGlmIChlcXVpcC5pc0VxdWlwZW1lbnQoKSlcbiAgICAgICAgZXF1aXBlbWVudHNBcnJheSA9IGVxdWlwZW1lbnRzQXJyYXkuY29uY2F0KGVxdWlwKTtcbiAgICAgIGVsc2UgZXF1aXBlbWVudHNBcnJheSA9IGVxdWlwZW1lbnRzQXJyYXkuY29uY2F0KGVxdWlwLmdldEVxdWlwZW1lbnRzKCkpO1xuICAgIH1cbiAgICByZXR1cm4gZXF1aXBlbWVudHNBcnJheTtcbiAgfVxuXG4gIGdldEFsbEJJTUdyb3VwcygpIHtcbiAgICBsZXQgcmVzID0gW107XG4gICAgcmVzLnB1c2godGhpcy5CSU1Hcm91cCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBjaGlsZCA9IHRoaXMuY2hpbGRyZW5baV07XG4gICAgICByZXMgPSByZXMuY29uY2F0KGNoaWxkLmdldEFsbEJJTUdyb3VwcygpKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHRlc3QoKSB7XG4gICAgY29uc29sZS5sb2codGhpcyk7XG4gIH1cblxuICBnZXRJdGVtcygpIHtcbiAgICBsZXQgdCA9IFtdO1xuICAgIHQgPSB0LmNvbmNhdCh0aGlzLkJJTUdyb3VwLmFycmF5T2ZJZCgpKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmNoaWxkcmVuW2ldO1xuICAgICAgbGV0IGNoaWxkSXRlbXMgPSBlbGVtZW50LmdldEl0ZW1zKCk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkSXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGNoaWxkSXRlbXNbaV07XG4gICAgICAgIGlmICh0LmluZGV4T2YoZWxlbWVudCkgPT09IC0xKSB0LnB1c2goZWxlbWVudCk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0O1xuICB9XG5cbiAgc2V0QWxsRGlzcGxheXMoX2Jvb2wpIHtcbiAgICBsZXQgdCA9IHRoaXMuZ2V0QWxsQklNR3JvdXBzKCk7XG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHQubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gdFtpbmRleF07XG4gICAgICBlbGVtZW50LmRpc3BsYXkuc2V0KF9ib29sKTtcbiAgICB9XG4gIH1cblxuICBzZXRBbGxEYXRhc0FjdGl2ZShfYm9vbCkge1xuICAgIGxldCB0ID0gdGhpcy5nZXRBbGxCSU1Hcm91cHMoKTtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdC5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGVsZW1lbnQgPSB0W2luZGV4XTtcbiAgICAgIGVsZW1lbnQuYWN0aXZlLnNldChfYm9vbCk7XG4gICAgfVxuICB9XG5cbiAgc2V0UGFyZW50KHBhcmVudCkge1xuICAgIHRoaXMucGFyZW50LnNldChwYXJlbnQpO1xuICB9XG5cbiAgbW9kUGFyZW50KHBhcmVudCkge1xuICAgIGlmICh0aGlzLnBhcmVudC5jb25zdHJ1Y3Rvci5uYW1lID09PSBwYXJlbnQuY29uc3RydWN0b3IubmFtZSlcbiAgICAgIHRoaXMucGFyZW50LnNldChwYXJlbnQpO1xuICAgIGVsc2Uge1xuICAgICAgdGhpcy5tb2RfYXR0cihcInBhcmVudFwiLCBwYXJlbnQpO1xuICAgICAgLy8gdGhpcy5tb2RfYXR0cigncGFyZW50JywgcGFyZW50KTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKHRoaXMucGFyZW50LmNvbnN0cnVjdG9yLm5hbWUpO1xuICAgIH1cbiAgfVxuXG4gIGdldFBhcmVudChjYiwgcmVqKSB7XG4gICAgdGhpcy5wYXJlbnQubG9hZChwYXJlbnQgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBjYiAhPSBcInVuZGVmaW5lZFwiKSBjYihwYXJlbnQpO1xuICAgICAgZWxzZSByZWoobmV3IEVycm9yKFwiUGFyZW50XCIpKVxuICAgIH0pO1xuICB9XG4gIGdldFBhcmVudEFzeW5jKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLnBhcmVudCk7XG4gICAgICB0aGlzLmdldFBhcmVudChyZXNvbHZlLCByZWplY3QpO1xuICAgIH0pO1xuICB9XG4gIHJlbW92ZVBhcmVudCgpIHtcbiAgICAvLyB0aGlzLm1vZFBhcmVudChuZXcgZ2xvYmFsVHlwZS5QdHIoMCkpO1xuICAgIHRoaXMuc2V0UGFyZW50KDApO1xuICB9XG5cbiAgcmVtb3ZlKCkge1xuICAgIGlmICghdGhpcy5pc1Jvb3QoKSkge1xuICAgICAgdGhpcy5nZXRQYXJlbnQocGFyZW50ID0+IHtcbiAgICAgICAgcGFyZW50LmNoaWxkcmVuLnJlbW92ZSh0aGlzKTtcbiAgICAgICAgZGVsZXRlIGdsb2JhbFR5cGUuRmlsZVN5c3RlbS5fb2JqZWN0c1t0aGlzLl9zZXJ2ZXJfaWRdO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgaXNSb290KCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnBhcmVudC5jb25zdHJ1Y3Rvci5uYW1lID09PSBcIlB0clwiICYmIHRoaXMucGFyZW50LmRhdGEudmFsdWUgPT09XG4gICAgICAwXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFJvb3QoKSB7XG4gICAgaWYgKHRoaXMuaXNSb290KCkpIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHJlc29sdmUodGhpcyk7XG4gICAgICAgIC8vIHJlamVjdChuZXcgRXJyb3IoXCJmYWlsXCIpKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0cnkge1xuICAgICAgICBsZXQgcm9vdENhbmRpZGF0ZSA9IGF3YWl0IHRoaXMuZ2V0UGFyZW50QXN5bmMoKTtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhyb290Q2FuZGlkYXRlLnRpdGxlLmdldCgpKTtcbiAgICAgICAgICAgIGxldCByb290ID0gYXdhaXQgcm9vdENhbmRpZGF0ZS5nZXRSb290KCk7XG4gICAgICAgICAgICByZXNvbHZlKHJvb3QpO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJFcnJvclwiKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVNob3dDb250ZW50KGJvb2wpIHtcbiAgICBpZiAodHlwZW9mIGJvb2wgIT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgdGhpcy5zaG93Q29udGVudC5zZXQoYm9vbCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCAmJiB0aGlzLkJJTUdyb3VwLkJJTU9iamVjdHMubGVuZ3RoID09PVxuICAgICAgMClcbiAgICAgIHRoaXMuc2hvd0NvbnRlbnQuc2V0KGZhbHNlKTtcbiAgfVxufVxuXG5zcGluYWxDb3JlLnJlZ2lzdGVyX21vZGVscyhbQ29uZmlndXJhdGlvbk5vZGVdKTsiXX0=