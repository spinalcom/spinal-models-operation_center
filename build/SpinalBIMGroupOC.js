"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _SpinalBIMObjectOC = require("./SpinalBIMObjectOC");

var _SpinalBIMObjectOC2 = _interopRequireDefault(_SpinalBIMObjectOC);

var _colors = require("../assets/utilities/colors");

var _colors2 = _interopRequireDefault(_colors);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const globalType = typeof window === "undefined" ? global : window;
const spinalCore = require("spinal-core-connectorjs");
const BIMForge = require("spinal-models-bim_forge");


let getViewer = function () {
  return globalType.v;
};

class SpinalBIMGroupOC extends BIMForge.SpinalBIMGroupForge {
  constructor(name = "SpinalBIMGroupOC") {
    super();
    if (FileSystem._sig_server) {
      this.add_attr({
        id: this.guid(),
        currentValue: 0,
        timeSeries: [],
        active: false
      });
      this.display.set(true);
    }
  }

  guid() {
    return this.constructor.name + "-" + this.s4() + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + "-" + this.s4() + this.s4() + this.s4() + "-" + Date.now().toString(16);
  }

  s4() {
    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
  }

  populateTimeSeries() {
    let max = 30;
    if (this.timeSeries.length >= max) {
      this.timeSeries.shift();
      this.timeSeries.push(this.currentValue.get());
    } else {
      this.timeSeries.push(this.currentValue.get());
    }
  }

  refreshColors(_coloringType) {
    let newcolor = _colors2.default.colorByValue(this.currentValue.get(), 40, 90);
    this.color.set(newcolor);
    let dbids = this.arrayOfId();
    if (_coloringType === 1) {
      let opacity = 0.5;
      let colorRGB = _colors2.default.toRGB(this.color.get(), opacity);
      for (let index = 0; index < this.BIMObjects.length; index++) {
        getViewer().setThemingColor(this.BIMObjects[index].id.get(), colorRGB);
      }
    } else {
      getViewer().setColorMaterial(dbids, this.color.get());
    }
    return dbids;
  }

  contains(itemId) {
    return this.arrayOfId().indexOf(itemId) !== -1;
  }

  addItem(itemId) {
    if (!this.contains(itemId)) {
      let newBIMObject = new _SpinalBIMObjectOC2.default(itemId, this.id.get());
      newBIMObject.fillInfo().then(() => {
        this.BIMObjects.push(newBIMObject);
      });
    }
  }

  addItems(input, index) {
    // input is a list of BIMObjects to add
    if (typeof index === "undefined") {
      input.forEach(i => {
        if (this.BIMObjects.indexOf(i) === -1) {
          this.BIMObjects.push(i);
        }
      });
    } else {
      for (let i = 0; i < input.length; i++) {
        const element = input[i];
        if (!this.BIMObjects.contains(element)) {
          this.BIMObjects.insert(index + i, [element]);
        }
      }
    }
  }

  removeItems(input) {
    // input is a list of BIMObjects to be removed
    var removedItems = [];
    for (var i = 0; i < input.length; ++i) {
      var index = this.BIMObjects.indexOf(input[i]);
      if (index !== -1) {
        removedItems.push(this.BIMObjects[index].get());
        this.BIMObjects.splice(index, 1);
      }
    }
    return removedItems;
  }

  removeItemByIndex(index) {
    let toBeRemove = this.BIMObjects[index];
    this.BIMObjects.splice(index, 1);
    return toBeRemove;
  }

  arrayOfId() {
    let t = [];
    for (let i = 0; i < this.BIMObjects.length; i++) {
      const item = this.BIMObjects[i];
      t.push(item.id.get());
    }
    return t;
  }

  isolate() {
    getViewer().isolateById(this.arrayOfId());
  }

  setCurrentValue(_value) {
    this.currentValue.set(_value);
    this.populateTimeSeries();
  }

}

exports.default = SpinalBIMGroupOC;
spinalCore.register_models([SpinalBIMGroupOC]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcGluYWxCSU1Hcm91cE9DLmpzIl0sIm5hbWVzIjpbImdsb2JhbFR5cGUiLCJ3aW5kb3ciLCJnbG9iYWwiLCJzcGluYWxDb3JlIiwicmVxdWlyZSIsIkJJTUZvcmdlIiwiZ2V0Vmlld2VyIiwidiIsIlNwaW5hbEJJTUdyb3VwT0MiLCJTcGluYWxCSU1Hcm91cEZvcmdlIiwiY29uc3RydWN0b3IiLCJuYW1lIiwiRmlsZVN5c3RlbSIsIl9zaWdfc2VydmVyIiwiYWRkX2F0dHIiLCJpZCIsImd1aWQiLCJjdXJyZW50VmFsdWUiLCJ0aW1lU2VyaWVzIiwiYWN0aXZlIiwiZGlzcGxheSIsInNldCIsInM0IiwiRGF0ZSIsIm5vdyIsInRvU3RyaW5nIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwic3Vic3RyaW5nIiwicG9wdWxhdGVUaW1lU2VyaWVzIiwibWF4IiwibGVuZ3RoIiwic2hpZnQiLCJwdXNoIiwiZ2V0IiwicmVmcmVzaENvbG9ycyIsIl9jb2xvcmluZ1R5cGUiLCJuZXdjb2xvciIsImNvbG9ycyIsImNvbG9yQnlWYWx1ZSIsImNvbG9yIiwiZGJpZHMiLCJhcnJheU9mSWQiLCJvcGFjaXR5IiwiY29sb3JSR0IiLCJ0b1JHQiIsImluZGV4IiwiQklNT2JqZWN0cyIsInNldFRoZW1pbmdDb2xvciIsInNldENvbG9yTWF0ZXJpYWwiLCJjb250YWlucyIsIml0ZW1JZCIsImluZGV4T2YiLCJhZGRJdGVtIiwibmV3QklNT2JqZWN0IiwiU3BpbmFsQklNT2JqZWN0T0MiLCJmaWxsSW5mbyIsInRoZW4iLCJhZGRJdGVtcyIsImlucHV0IiwiZm9yRWFjaCIsImkiLCJlbGVtZW50IiwiaW5zZXJ0IiwicmVtb3ZlSXRlbXMiLCJyZW1vdmVkSXRlbXMiLCJzcGxpY2UiLCJyZW1vdmVJdGVtQnlJbmRleCIsInRvQmVSZW1vdmUiLCJ0IiwiaXRlbSIsImlzb2xhdGUiLCJpc29sYXRlQnlJZCIsInNldEN1cnJlbnRWYWx1ZSIsIl92YWx1ZSIsInJlZ2lzdGVy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aEIsRUFBd0I7QUFDdEIsU0FBSzFELFlBQUwsQ0FBa0JJLEdBQWxCLENBQXNCc0QsTUFBdEI7QUFDQSxTQUFLN0Msa0JBQUw7QUFDRDs7QUEzSXdFOztrQkFBdER0QixnQjtBQWdKckJMLFdBQVd5RSxlQUFYLENBQTJCLENBQUNwRSxnQkFBRCxDQUEzQiIsImZpbGUiOiJTcGluYWxCSU1Hcm91cE9DLmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZ2xvYmFsVHlwZSA9IHR5cGVvZiB3aW5kb3cgPT09IFwidW5kZWZpbmVkXCIgPyBnbG9iYWwgOiB3aW5kb3c7XG5jb25zdCBzcGluYWxDb3JlID0gcmVxdWlyZShcInNwaW5hbC1jb3JlLWNvbm5lY3RvcmpzXCIpO1xuY29uc3QgQklNRm9yZ2UgPSByZXF1aXJlKFwic3BpbmFsLW1vZGVscy1iaW1fZm9yZ2VcIik7XG5pbXBvcnQgU3BpbmFsQklNT2JqZWN0T0MgZnJvbSBcIi4vU3BpbmFsQklNT2JqZWN0T0NcIlxuaW1wb3J0IGNvbG9ycyBmcm9tIFwiLi4vYXNzZXRzL3V0aWxpdGllcy9jb2xvcnNcIlxuXG5cbmxldCBnZXRWaWV3ZXIgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIGdsb2JhbFR5cGUudjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3BpbmFsQklNR3JvdXBPQyBleHRlbmRzIEJJTUZvcmdlLlNwaW5hbEJJTUdyb3VwRm9yZ2Uge1xuICBjb25zdHJ1Y3RvcihuYW1lID0gXCJTcGluYWxCSU1Hcm91cE9DXCIpIHtcbiAgICBzdXBlcigpO1xuICAgIGlmIChGaWxlU3lzdGVtLl9zaWdfc2VydmVyKSB7XG4gICAgICB0aGlzLmFkZF9hdHRyKHtcbiAgICAgICAgaWQ6IHRoaXMuZ3VpZCgpLFxuICAgICAgICBjdXJyZW50VmFsdWU6IDAsXG4gICAgICAgIHRpbWVTZXJpZXM6IFtdLFxuICAgICAgICBhY3RpdmU6IGZhbHNlXG4gICAgICB9KTtcbiAgICAgIHRoaXMuZGlzcGxheS5zZXQodHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgZ3VpZCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIFwiLVwiICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICBcIi1cIiArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgdGhpcy5zNCgpICtcbiAgICAgIHRoaXMuczQoKSArXG4gICAgICB0aGlzLnM0KCkgK1xuICAgICAgXCItXCIgK1xuICAgICAgRGF0ZS5ub3coKS50b1N0cmluZygxNilcbiAgICApO1xuICB9XG5cbiAgczQoKSB7XG4gICAgcmV0dXJuIE1hdGguZmxvb3IoKDEgKyBNYXRoLnJhbmRvbSgpKSAqIDB4MTAwMDApXG4gICAgICAudG9TdHJpbmcoMTYpXG4gICAgICAuc3Vic3RyaW5nKDEpO1xuICB9XG5cbiAgcG9wdWxhdGVUaW1lU2VyaWVzKCkge1xuICAgIGxldCBtYXggPSAzMDtcbiAgICBpZiAodGhpcy50aW1lU2VyaWVzLmxlbmd0aCA+PSBtYXgpIHtcbiAgICAgIHRoaXMudGltZVNlcmllcy5zaGlmdCgpO1xuICAgICAgdGhpcy50aW1lU2VyaWVzLnB1c2godGhpcy5jdXJyZW50VmFsdWUuZ2V0KCkpXG5cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aW1lU2VyaWVzLnB1c2godGhpcy5jdXJyZW50VmFsdWUuZ2V0KCkpXG4gICAgfVxuICB9XG5cbiAgcmVmcmVzaENvbG9ycyhfY29sb3JpbmdUeXBlKSB7XG4gICAgbGV0IG5ld2NvbG9yID0gY29sb3JzLmNvbG9yQnlWYWx1ZSh0aGlzLmN1cnJlbnRWYWx1ZS5nZXQoKSwgNDAsIDkwKVxuICAgIHRoaXMuY29sb3Iuc2V0KG5ld2NvbG9yKTtcbiAgICBsZXQgZGJpZHMgPSB0aGlzLmFycmF5T2ZJZCgpO1xuICAgIGlmIChfY29sb3JpbmdUeXBlID09PSAxKSB7XG4gICAgICBsZXQgb3BhY2l0eSA9IDAuNVxuICAgICAgbGV0IGNvbG9yUkdCID0gY29sb3JzLnRvUkdCKHRoaXMuY29sb3IuZ2V0KCksIG9wYWNpdHkpXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5CSU1PYmplY3RzLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgICBnZXRWaWV3ZXIoKS5zZXRUaGVtaW5nQ29sb3IodGhpcy5CSU1PYmplY3RzW2luZGV4XS5pZC5nZXQoKSxcbiAgICAgICAgICBjb2xvclJHQik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGdldFZpZXdlcigpLnNldENvbG9yTWF0ZXJpYWwoZGJpZHMsIHRoaXMuY29sb3IuZ2V0KCkpO1xuICAgIH1cbiAgICByZXR1cm4gZGJpZHM7XG4gIH1cblxuICBjb250YWlucyhpdGVtSWQpIHtcbiAgICByZXR1cm4gdGhpcy5hcnJheU9mSWQoKS5pbmRleE9mKGl0ZW1JZCkgIT09IC0xO1xuICB9XG5cblxuXG4gIGFkZEl0ZW0oaXRlbUlkKSB7XG4gICAgaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW1JZCkpIHtcbiAgICAgIGxldCBuZXdCSU1PYmplY3QgPSBuZXcgU3BpbmFsQklNT2JqZWN0T0MoaXRlbUlkLCB0aGlzLmlkLmdldCgpKTtcbiAgICAgIG5ld0JJTU9iamVjdC5maWxsSW5mbygpLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLkJJTU9iamVjdHMucHVzaChuZXdCSU1PYmplY3QpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cblxuXG4gIGFkZEl0ZW1zKGlucHV0LCBpbmRleCkge1xuICAgIC8vIGlucHV0IGlzIGEgbGlzdCBvZiBCSU1PYmplY3RzIHRvIGFkZFxuICAgIGlmICh0eXBlb2YgaW5kZXggPT09IFwidW5kZWZpbmVkXCIpIHtcbiAgICAgIGlucHV0LmZvckVhY2goaSA9PiB7XG4gICAgICAgIGlmICh0aGlzLkJJTU9iamVjdHMuaW5kZXhPZihpKSA9PT0gLTEpIHtcbiAgICAgICAgICB0aGlzLkJJTU9iamVjdHMucHVzaChpKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IGlucHV0W2ldO1xuICAgICAgICBpZiAoIXRoaXMuQklNT2JqZWN0cy5jb250YWlucyhlbGVtZW50KSkge1xuICAgICAgICAgIHRoaXMuQklNT2JqZWN0cy5pbnNlcnQoaW5kZXggKyBpLCBbZWxlbWVudF0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlSXRlbXMoaW5wdXQpIHtcbiAgICAvLyBpbnB1dCBpcyBhIGxpc3Qgb2YgQklNT2JqZWN0cyB0byBiZSByZW1vdmVkXG4gICAgdmFyIHJlbW92ZWRJdGVtcyA9IFtdO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyArK2kpIHtcbiAgICAgIHZhciBpbmRleCA9IHRoaXMuQklNT2JqZWN0cy5pbmRleE9mKGlucHV0W2ldKTtcbiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgcmVtb3ZlZEl0ZW1zLnB1c2godGhpcy5CSU1PYmplY3RzW2luZGV4XS5nZXQoKSk7XG4gICAgICAgIHRoaXMuQklNT2JqZWN0cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVtb3ZlZEl0ZW1zO1xuICB9XG5cbiAgcmVtb3ZlSXRlbUJ5SW5kZXgoaW5kZXgpIHtcbiAgICBsZXQgdG9CZVJlbW92ZSA9IHRoaXMuQklNT2JqZWN0c1tpbmRleF1cbiAgICB0aGlzLkJJTU9iamVjdHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICByZXR1cm4gdG9CZVJlbW92ZTtcbiAgfVxuXG4gIGFycmF5T2ZJZCgpIHtcbiAgICBsZXQgdCA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5CSU1PYmplY3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBpdGVtID0gdGhpcy5CSU1PYmplY3RzW2ldO1xuICAgICAgdC5wdXNoKGl0ZW0uaWQuZ2V0KCkpO1xuICAgIH1cbiAgICByZXR1cm4gdDtcbiAgfVxuXG4gIGlzb2xhdGUoKSB7XG4gICAgZ2V0Vmlld2VyKCkuaXNvbGF0ZUJ5SWQodGhpcy5hcnJheU9mSWQoKSk7XG4gIH1cblxuICBzZXRDdXJyZW50VmFsdWUoX3ZhbHVlKSB7XG4gICAgdGhpcy5jdXJyZW50VmFsdWUuc2V0KF92YWx1ZSlcbiAgICB0aGlzLnBvcHVsYXRlVGltZVNlcmllcygpO1xuICB9XG5cblxufVxuXG5zcGluYWxDb3JlLnJlZ2lzdGVyX21vZGVscyhbU3BpbmFsQklNR3JvdXBPQ10pIl19