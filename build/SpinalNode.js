"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
const spinalCore = require("spinal-core-connectorjs");
const globalType = typeof window === "undefined" ? global : window;
let getViewer = function () {
  return globalType.v;
};

class SpinalNode extends globalType.Model {
  constructor(_parent, _element, _options) {
    super();
    if (FileSystem._sig_server) {
      if (_parent === 0) this.add_attr({
        relOptions: _options
      });
      this.add_attr({
        children: new Lst(),
        childNameId: 0,
        parent: new Ptr(_parent),
        element: _element,
        showContent: false
      });
    }
  }
  updateShowContent(bool) {
    if (typeof bool != "undefined") {
      this.showContent.set(bool);
      return;
    }
    if (this.children.length === 0) this.showContent.set(false);
  }

  incrementChildNameId() {
    this.childNameId.set(this.childNameId.get() + 1);
    return this.childNameId.get();
  }

  createChild() {
    let operationCenterObject = new OperationCenterObject();
    operationCenterObject.setName(this.element.name.get() + "-" + this.incrementChildNameId().toString());
    let child = new SpinalNode(this, operationCenterObject);
    this.addChild(child);
  }

  addChild(child, index) {
    if (typeof index == "undefined") this.children.push(child);
    // else
    //   this.children.push()
  }

  addChildren(children) {
    for (let i = 0; i < children.length; i++) {
      this.children.push(children[i]);
    }
  }

  getChildren() {
    return this.children.get();
  }

  //   getName() {
  //     return this.name.get();
  //   }

  //   setName(name) {
  //     this.name.set(name);
  //   }

  removeChildren() {
    this.children.set(null);
  }

  isLeaf() {
    if (this.children.length == 0) return true;else return false;
  }

  setParent(parent) {
    this.parent.set(parent);
  }

  modParent(parent) {
    if (this.parent.constructor.name === parent.constructor.name) this.parent.set(parent);else {
      this.mod_attr("parent", parent);
    }
  }

  getParent(cb, rej) {
    this.parent.load(parent => {
      if (typeof cb != "undefined") cb(parent);else rej(new Error("Parent"));
    });
  }
  getParentAsync() {
    return new Promise((resolve, reject) => {
      this.getParent(resolve, reject);
    });
  }
  removeParent() {
    this.setParent(0);
  }
  removeChild(_child) {
    for (let index = 0; index < this.children.length; index++) {
      const child = this.children[index];
      if (child.id.get() === _child.id.get()) this.children.splice(index, 1);
    }
  }

  remove() {
    if (!this.isRoot()) {
      this.getParent(parent => {
        parent.children.remove(this);
        delete globalType.FileSystem._objects[this._server_id];
      });
    }
  }

  isRoot() {
    return this.parent.constructor.name === "Ptr" && this.parent.data.value === 0;
  }

  async getRoot() {
    if (this.isRoot()) {
      return new Promise((resolve, reject) => {
        resolve(this);
      });
    } else {
      try {
        let rootCandidate = await this.getParentAsync();
        return new Promise(async function (resolve, reject) {
          try {
            let root = await rootCandidate.getRoot();
            resolve(root);
          } catch (error) {
            console.error(error);
          }
        });
      } catch (error) {
        console.error(error);
      }
    }
  }
}

exports.default = SpinalNode;
spinalCore.register_models([SpinalNode]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TcGluYWxOb2RlLmpzIl0sIm5hbWVzIjpbInNwaW5hbENvcmUiLCJyZXF1aXJlIiwiZ2xvYmFsVHlwZSIsIndpbmRvdyIsImdsb2JhbCIsImdldFZpZXdlciIsInYiLCJTcGluYWxOb2RlIiwiTW9kZWwiLCJjb25zdHJ1Y3RvciIsIl9wYXJlbnQiLCJfZWxlbWVudCIsIl9vcHRpb25zIiwiRmlsZVN5c3RlbSIsIl9zaWdfc2VydmVyIiwiYWRkX2F0dHIiLCJyZWxPcHRpb25zIiwiY2hpbGRyZW4iLCJMc3QiLCJjaGlsZE5hbWVJZCIsInBhcmVudCIsIlB0ciIsImVsZW1lbnQiLCJzaG93Q29udGVudCIsInVwZGF0ZVNob3dDb250ZW50IiwiYm9vbCIsInNldCIsImxlbmd0aCIsImluY3JlbWVudENoaWxkTmFtZUlkIiwiZ2V0IiwiY3JlYXRlQ2hpbGQiLCJvcGVyYXRpb25DZW50ZXJPYmplY3QiLCJPcGVyYXRpb25DZW50ZXJPYmplY3QiLCJzZXROYW1lIiwibmFtZSIsInRvU3RyaW5nIiwiY2hpbGQiLCJhZGRDaGlsZCIsImluZGV4IiwicHVzaCIsImFkZENoaWxkcmVuIiwiaSIsImdldENoaWxkcmVuIiwicmVtb3ZlQ2hpbGRyZW4iLCJpc0xlYWYiLCJzZXRQYXJlbnQiLCJtb2RQYXJlbnQiLCJtb2RfYXR0ciIsImdldFBhcmVudCIsImNiIiwicmVqIiwibG9hZCIsIkVycm9yIiwiZ2V0UGFyZW50QXN5bmMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInJlbW92ZVBhcmVudCIsInJlbW92ZUNoaWxkIiwiX2NoaWxkIiwiaWQiLCJzcGxpY2UiLCJyZW1vdmUiLCJpc1Jvb3QiLCJfb2JqZWN0cyIsIl9zZXJ2ZXJfaWQiLCJkYXRhIiwidmFsdWUiLCJnZXRSb290Iiwicm9vdENhbmRpZGF0ZSIsInJvb3QiLCJlcnJvciIsImNvbnNvbGUiLCJyZWdpc3Rlcl9tb2RlbHMiXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsTUFBTUEsYUFBYUMs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LENBQStCLEtBQUtDLFVBQXBDLENBQVA7QUFDRCxPQUhEO0FBSUQ7QUFDRjs7QUFFREYsV0FBUztBQUNQLFdBQ0UsS0FBSzNDLE1BQUwsQ0FBWVgsV0FBWixDQUF3QnlCLElBQXhCLEtBQWlDLEtBQWpDLElBQTBDLEtBQUtkLE1BQUwsQ0FBWThDLElBQVosQ0FBaUJDLEtBQWpCLEtBQzFDLENBRkY7QUFJRDs7QUFFRCxRQUFNQyxPQUFOLEdBQWdCO0FBQ2QsUUFBSSxLQUFLTCxNQUFMLEVBQUosRUFBbUI7QUFDakIsYUFBTyxJQUFJVCxPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDRCxnQkFBUSxJQUFSO0FBQ0QsT0FGTSxDQUFQO0FBR0QsS0FKRCxNQUlPO0FBQ0wsVUFBSTtBQUNGLFlBQUljLGdCQUFnQixNQUFNLEtBQUtoQixjQUFMLEVBQTFCO0FBQ0EsZUFBTyxJQUFJQyxPQUFKLENBQVksZ0JBQWVDLE9BQWYsRUFBd0JDLE1BQXhCLEVBQWdDO0FBQ2pELGNBQUk7QUFDRixnQkFBSWMsT0FBTyxNQUFNRCxjQUFjRCxPQUFkLEVBQWpCO0FBQ0FiLG9CQUFRZSxJQUFSO0FBQ0QsV0FIRCxDQUdFLE9BQU9DLEtBQVAsRUFBYztBQUNkQyxvQkFBUUQsS0FBUixDQUFjQSxLQUFkO0FBQ0Q7QUFDRixTQVBNLENBQVA7QUFRRCxPQVZELENBVUUsT0FBT0EsS0FBUCxFQUFjO0FBQ2RDLGdCQUFRRCxLQUFSLENBQWNBLEtBQWQ7QUFDRDtBQUNGO0FBQ0Y7QUFwSnNEOztrQkFBcENoRSxVO0FBdUpyQlAsV0FBV3lFLGVBQVgsQ0FBMkIsQ0FBQ2xFLFVBQUQsQ0FBM0IiLCJmaWxlIjoiU3BpbmFsTm9kZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHNwaW5hbENvcmUgPSByZXF1aXJlKFwic3BpbmFsLWNvcmUtY29ubmVjdG9yanNcIik7XG5jb25zdCBnbG9iYWxUeXBlID0gdHlwZW9mIHdpbmRvdyA9PT0gXCJ1bmRlZmluZWRcIiA/IGdsb2JhbCA6IHdpbmRvdztcbmxldCBnZXRWaWV3ZXIgPSBmdW5jdGlvbigpIHtcbiAgcmV0dXJuIGdsb2JhbFR5cGUudjtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNwaW5hbE5vZGUgZXh0ZW5kcyBnbG9iYWxUeXBlLk1vZGVsIHtcbiAgY29uc3RydWN0b3IoX3BhcmVudCwgX2VsZW1lbnQsIF9vcHRpb25zKSB7XG4gICAgc3VwZXIoKTtcbiAgICBpZiAoRmlsZVN5c3RlbS5fc2lnX3NlcnZlcikge1xuICAgICAgaWYgKF9wYXJlbnQgPT09IDApXG4gICAgICAgIHRoaXMuYWRkX2F0dHIoe1xuICAgICAgICAgIHJlbE9wdGlvbnM6IF9vcHRpb25zXG4gICAgICAgIH0pO1xuICAgICAgdGhpcy5hZGRfYXR0cih7XG4gICAgICAgIGNoaWxkcmVuOiBuZXcgTHN0KCksXG4gICAgICAgIGNoaWxkTmFtZUlkOiAwLFxuICAgICAgICBwYXJlbnQ6IG5ldyBQdHIoX3BhcmVudCksXG4gICAgICAgIGVsZW1lbnQ6IF9lbGVtZW50LFxuICAgICAgICBzaG93Q29udGVudDogZmFsc2UsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgdXBkYXRlU2hvd0NvbnRlbnQoYm9vbCkge1xuICAgIGlmICh0eXBlb2YgYm9vbCAhPSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICB0aGlzLnNob3dDb250ZW50LnNldChib29sKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4ubGVuZ3RoID09PSAwKVxuICAgICAgdGhpcy5zaG93Q29udGVudC5zZXQoZmFsc2UpO1xuICB9XG5cblxuICBpbmNyZW1lbnRDaGlsZE5hbWVJZCgpIHtcbiAgICB0aGlzLmNoaWxkTmFtZUlkLnNldCh0aGlzLmNoaWxkTmFtZUlkLmdldCgpICsgMSk7XG4gICAgcmV0dXJuIHRoaXMuY2hpbGROYW1lSWQuZ2V0KCk7XG4gIH1cblxuXG4gIGNyZWF0ZUNoaWxkKCkge1xuICAgIGxldCBvcGVyYXRpb25DZW50ZXJPYmplY3QgPSBuZXcgT3BlcmF0aW9uQ2VudGVyT2JqZWN0KClcbiAgICBvcGVyYXRpb25DZW50ZXJPYmplY3Quc2V0TmFtZShcbiAgICAgIHRoaXMuZWxlbWVudC5uYW1lLmdldCgpICsgXCItXCIgKyB0aGlzLmluY3JlbWVudENoaWxkTmFtZUlkKCkudG9TdHJpbmcoKVxuICAgIClcbiAgICBsZXQgY2hpbGQgPSBuZXcgU3BpbmFsTm9kZSh0aGlzLCBvcGVyYXRpb25DZW50ZXJPYmplY3QpO1xuICAgIHRoaXMuYWRkQ2hpbGQoY2hpbGQpO1xuICB9XG5cblxuXG4gIGFkZENoaWxkKGNoaWxkLCBpbmRleCkge1xuICAgIGlmICh0eXBlb2YgaW5kZXggPT0gXCJ1bmRlZmluZWRcIikgdGhpcy5jaGlsZHJlbi5wdXNoKGNoaWxkKTtcbiAgICAvLyBlbHNlXG4gICAgLy8gICB0aGlzLmNoaWxkcmVuLnB1c2goKVxuICB9XG5cbiAgYWRkQ2hpbGRyZW4oY2hpbGRyZW4pIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICB0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGRyZW5baV0pO1xuICAgIH1cbiAgfVxuXG4gIGdldENoaWxkcmVuKCkge1xuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLmdldCgpO1xuICB9XG5cbiAgLy8gICBnZXROYW1lKCkge1xuICAvLyAgICAgcmV0dXJuIHRoaXMubmFtZS5nZXQoKTtcbiAgLy8gICB9XG5cbiAgLy8gICBzZXROYW1lKG5hbWUpIHtcbiAgLy8gICAgIHRoaXMubmFtZS5zZXQobmFtZSk7XG4gIC8vICAgfVxuXG4gIHJlbW92ZUNoaWxkcmVuKCkge1xuICAgIHRoaXMuY2hpbGRyZW4uc2V0KG51bGwpO1xuICB9XG5cbiAgaXNMZWFmKCkge1xuICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PSAwKSByZXR1cm4gdHJ1ZTtcbiAgICBlbHNlIHJldHVybiBmYWxzZTtcbiAgfVxuXG5cbiAgc2V0UGFyZW50KHBhcmVudCkge1xuICAgIHRoaXMucGFyZW50LnNldChwYXJlbnQpO1xuICB9XG5cbiAgbW9kUGFyZW50KHBhcmVudCkge1xuICAgIGlmICh0aGlzLnBhcmVudC5jb25zdHJ1Y3Rvci5uYW1lID09PSBwYXJlbnQuY29uc3RydWN0b3IubmFtZSlcbiAgICAgIHRoaXMucGFyZW50LnNldChwYXJlbnQpO1xuICAgIGVsc2Uge1xuICAgICAgdGhpcy5tb2RfYXR0cihcInBhcmVudFwiLCBwYXJlbnQpO1xuICAgIH1cbiAgfVxuXG4gIGdldFBhcmVudChjYiwgcmVqKSB7XG4gICAgdGhpcy5wYXJlbnQubG9hZChwYXJlbnQgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBjYiAhPSBcInVuZGVmaW5lZFwiKSBjYihwYXJlbnQpO1xuICAgICAgZWxzZSByZWoobmV3IEVycm9yKFwiUGFyZW50XCIpKVxuICAgIH0pO1xuICB9XG4gIGdldFBhcmVudEFzeW5jKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldFBhcmVudChyZXNvbHZlLCByZWplY3QpO1xuICAgIH0pO1xuICB9XG4gIHJlbW92ZVBhcmVudCgpIHtcbiAgICB0aGlzLnNldFBhcmVudCgwKTtcbiAgfVxuICByZW1vdmVDaGlsZChfY2hpbGQpIHtcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGNoaWxkID0gdGhpcy5jaGlsZHJlbltpbmRleF07XG4gICAgICBpZiAoY2hpbGQuaWQuZ2V0KCkgPT09IF9jaGlsZC5pZC5nZXQoKSlcbiAgICAgICAgdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDEpXG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKCkge1xuICAgIGlmICghdGhpcy5pc1Jvb3QoKSkge1xuICAgICAgdGhpcy5nZXRQYXJlbnQocGFyZW50ID0+IHtcbiAgICAgICAgcGFyZW50LmNoaWxkcmVuLnJlbW92ZSh0aGlzKTtcbiAgICAgICAgZGVsZXRlIGdsb2JhbFR5cGUuRmlsZVN5c3RlbS5fb2JqZWN0c1t0aGlzLl9zZXJ2ZXJfaWRdO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgaXNSb290KCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnBhcmVudC5jb25zdHJ1Y3Rvci5uYW1lID09PSBcIlB0clwiICYmIHRoaXMucGFyZW50LmRhdGEudmFsdWUgPT09XG4gICAgICAwXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldFJvb3QoKSB7XG4gICAgaWYgKHRoaXMuaXNSb290KCkpIHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHJlc29sdmUodGhpcyk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IHJvb3RDYW5kaWRhdGUgPSBhd2FpdCB0aGlzLmdldFBhcmVudEFzeW5jKCk7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyBmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHJvb3QgPSBhd2FpdCByb290Q2FuZGlkYXRlLmdldFJvb3QoKTtcbiAgICAgICAgICAgIHJlc29sdmUocm9vdCk7XG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuc3BpbmFsQ29yZS5yZWdpc3Rlcl9tb2RlbHMoW1NwaW5hbE5vZGVdKTsiXX0=