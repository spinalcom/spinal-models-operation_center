"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _SpinalNode = require("./SpinalNode");

var _SpinalNode2 = _interopRequireDefault(_SpinalNode);

var _Zone = require("./Zone");

var _Zone2 = _interopRequireDefault(_Zone);

var _SpinalBIMGroupOC = require("./SpinalBIMGroupOC");

var _SpinalBIMGroupOC2 = _interopRequireDefault(_SpinalBIMGroupOC);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const spinalCore = require("spinal-core-connectorjs");
const globalType = typeof window === "undefined" ? global : window;

let getViewer = function () {
  return globalType.v;
};

class ZoneNode extends _SpinalNode2.default {
  constructor(_parent, _element, _options) {
    super(_parent, _element, _options);
  }

  incrementEquipementNameId() {
    globalType.operationCenter.options.equipementNameId.set(globalType.operationCenter.options.equipementNameId.get() + 1);
    return globalType.operationCenter.options.equipementNameId.get();
  }

  createChild(_type, _relZoneAggregatesList, _zoneList) {
    let zone = new _Zone2.default(_type);
    if (_type === "Zone") zone.setName(this.element.name.get() + "-" + this.incrementChildNameId().toString());
    if (_type === "Equipement") zone.setName(" Equipement-" + this.incrementEquipementNameId().toString());

    _zoneList.addZone(zone);
    this.element.addRelation('relZoneAggregates', zone);
    let tree = new ZoneNode(this, zone);

    this.addChild(tree);
    if (!_relZoneAggregatesList.containsByRelatingId(this.element.id.get())) _relZoneAggregatesList.addRelZoneAggregates(this.element, [zone]);else {
      let rel = _relZoneAggregatesList.getByRelatingId(this.element.id.get());
      try {
        rel.addRelatedObjects(zone);
      } catch (error) {
        console.error(e);
      }
    }
  }

  addBIMObject(_objectId) {
    if (typeof this.element['relZoneContains'] === "undefined") {
      let BIMGroup = new _SpinalBIMGroupOC2.default();
      BIMGroup.addItem(_objectId);
      this.element.addRelation('relZoneContains', BIMGroup);
    } else {
      this.element['relZoneContains'].load(BIMGroupLst => {
        BIMGroupLst[0].addItem(_objectId);
      });
    }
  }

  addTreeFromRelation(_zone) {
    var tree = new ZoneNode(this, _zone);
    this.addChild(tree);
  }

  getSpinalNodeByZoneId(_id) {
    if (this.element.id.get() == _id) return this;else {
      for (let index = 0; index < this.children.length; index++) {
        const spinalNode = this.children[index];
        let res = spinalNode.getSpinalNodeByZoneId(_id);
        if (res != null) return spinalNode;
      }
    }
  }

  getEquipements() {
    let equipementsArray = [];
    for (let i = 0; i < this.children.length; i++) {
      const equip = this.children[i].element;
      const node = this.children[i];
      // console.log("recur", equip.type.get());
      // console.log(equipementsArray);
      // console.log(equip.isEquipement());
      if (equip.isEquipement()) equipementsArray = equipementsArray.concat(equip.element);else equipementsArray = equipementsArray.concat(node.getEquipements());
    }
    return equipementsArray;
  }

  async getAllBIMGroups() {
    let res = [];
    if (typeof this.element['relZoneContains'] !== "undefined") {
      let BIMGroupLst = await this.promiseLoad(this.element['relZoneContains']);
      res.push(BIMGroupLst[0]);
      for (let i = 0; i < this.children.length; i++) {
        const child = this.children[i];
        let tmp = await child.getAllBIMGroups();
        // if (tmp !== null)
        res = res.concat(tmp);
      }
    }
    return res;
  }

  promiseLoad(_ptr) {
    return new Promise(resolve => {
      _ptr.load(resolve);
    });
  }

  async getItems() {
    let t = [];
    if (typeof this.element['relZoneContains'] !== "undefined") {
      let BIMGroupLst = await this.promiseLoad(this.element['relZoneContains']);
      t = t.concat(BIMGroupLst[0].arrayOfId());
      for (let i = 0; i < this.children.length; i++) {
        const element = this.children[i];
        let childItems = await element.getItems();
        // if (typeof childItems !== "undefined")
        for (let i = 0; i < childItems.length; i++) {
          const element = childItems[i];
          if (t.indexOf(element) === -1) t.push(element);
        }
      }
    }
    return t;
  }

  async setAllDisplays(_bool) {
    let t = await this.getAllBIMGroups();
    // if (t != null)
    for (let index = 0; index < t.length; index++) {
      const element = t[index];
      element.display.set(_bool);
    }
  }

  async setAllDatasActive(_bool) {
    let t = await this.getAllBIMGroups();
    // if (t != null)
    for (let index = 0; index < t.length; index++) {
      const element = t[index];
      element.active.set(_bool);
    }
  }

  updateShowContent(bool) {
    if (typeof bool != "undefined") {
      this.showContent.set(bool);
      return;
    }
    if (typeof this.element['relZoneContains'] !== "undefined") this.element['relZoneContains'].load(BIMGroupLst => {
      if (this.children.length === 0 && BIMGroupLst[0].BIMObjects.length === 0) this.showContent.set(false);
    });
  }

}

exports.default = ZoneNode;
spinalCore.register_models([ZoneNode]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9ab25lTm9kZS5qcyJdLCJuYW1lcyI6WyJzcGluYWxDb3JlIiwicmVxdWlyZSIsImdsb2JhbFR5cGUiLCJ3aW5kb3ciLCJnbG9iYWwiLCJnZXRWaWV3ZXIiLCJ2IiwiWm9uZU5vZGUiLCJTcGluYWxOb2RlIiwiY29uc3RydWN0b3IiLCJfcGFyZW50IiwiX2VsZW1lbnQiLCJfb3B0aW9ucyIsImluY3JlbWVudEVxdWlwZW1lbnROYW1lSWQiLCJvcGVyYXRpb25DZW50ZXIiLCJvcHRpb25zIiwiZXF1aXBlbWVudE5hbWVJZCIsInNldCIsImdldCIsImNyZWF0ZUNoaWxkIiwiX3R5cGUiLCJfcmVsWm9uZUFnZ3JlZ2F0ZXNMaXN0IiwiX3pvbmVMaXN0Iiwiem9uZSIsIlpvbmUiLCJzZXROYW1lIiwiZWxlbWVudCIsIm5hbWUiLCJpbmNyZW1lbnRDaGlsZE5hbWVJZCIsInRvU3RyaW5nIiwiYWRkWm9uZSIsImFkZFJlbGF0aW9uIiwidHJlZSIsImFkZENoaWxkIiwiY29udGFpbnNCeVJlbGF0aW5nSWQiLCJpZCIsImFkZFJlbFpvbmVBZ2dyZWdhdGVzIiwicmVsIiwiZ2V0QnlSZWxhdGluZ0lkIiwiYWRkUmVsYXRlZE9iamVjdHMiLCJlcnJvciIsImNvbnNvbGUiLCJlIiwiYWRkQklNT2JqZWN0IiwiX29iamVjdElkIiwiQklNR3JvdXAiLCJTcGluYWxCSU1Hcm91cE9DIiwiYWRkSXRlbSIsImxvYWQiLCJCSU1Hcm91cExzdCIsImFkZFRyZWVGcm9tUmVsYXRpb24iLCJfem9uZSIsImdldFNwaW5hbE5vZGVCeVpvbmVJZCIsIl9pZCIsImluZGV4IiwiY2hpbGRyZW4iLCJsZW5ndGgiLCJzcGluYWxOb2RlIiwicmVzIiwiZ2V0RXF1aXBlbWVudHMiLCJlcXVpcGVtZW50c0FycmF5IiwiaSIsImVxdWlwIiwibm9kZSIsImlzRXF1aXBlbWVudCIsImNvbmNhdCIsImdldEFsbEJJTUdyb3VwcyIsInByb21pc2VMb2FkIiwicHVzaCIsImNoaWxkIiwidG1wIiwiX3B0ciIsIlByb21pc2UiLCJyZXNvbHZlIiwiZ2V0SXRlbXMiLCJ0IiwiYXJyYXlPZklkIiwiY2hpbGRJdGVtcyIsImluZGV4T2YiLCJzZXRBbGxEaXNwbGF5cyIsIl9ib29sIiwiZGlzcGxheSIsInNldEFsbERhdGFzQWN0aXZlIiwiYWN0aXZlIiwidXBkYXRlU2hvd0NvbnRlbnQiLCJib29sIiwic2hvd0NvbnRlbnQiLCJCSU1PYmplY3RzIiwicmVnaXN0ZXJfbW9kZWxzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUpBLE1BQU1BLGFBQWFDLFFBQVEseUJBQVIsQ0FBbkI7QUFDQSxNQUFNQyxhQUFhLE9BQU9DLE1BQVAsS0FBa0IsV0FBbEIsR0FBZ0NDLE1BQWhDLEdBQXlDRCxNQUE1RDs7QUFJQSxJQUFJRSxZQUFZLFlBQVc7QUFDekIsU0FBT0gsV0FBV0ksQ0FBbEI7QUFDRCxDQUZEOztBQUllLE1BQU1DLFFBQU4sU0FBdUJDLG9CQUF2QixDQUFrQztBQUMvQ0MsY0FBWUMsT0FBWixFQUFxQkMsUUFBckIsRUFBK0JDLFFBQS9CLEVBQXlDO0FBQ3ZDLFVBQU1GLE9BQU4sRUFBZUMsUUFBZixFQUF5QkMsUUFBekI7QUFDRDs7QUFFREMsOEJBQTRCO0FBQzFCWCxlQUFXWSxlQUFYLENBQTJCQyxPQUEzQixDQUFtQ0MsZ0JBQW5DLENBQ0dDLEdBREgsQ0FDT2YsV0FBV1ksZUFBWCxDQUEyQkMsT0FBM0IsQ0FBbUNDLGdCQUFuQyxDQUFvREUsR0FBcEQsS0FBNEQsQ0FEbkU7QUFFQSxXQUFPaEIsV0FBV1ksZUFBWCxDQUEyQkMsT0FBM0IsQ0FBbUNDLGdCQUFuQyxDQUFvREUsR0FBcEQsRUFBUDtBQUNEOztBQUVEQyxjQUFZQyxLQUFaLEVBQW1CQyxzQkFBbkIsRUFBMkNDLFNBQTNDLEVBQXNEO0FBQ3BELFFBQUlDLE9BQU8sSUFBSUMsY0FBSixDQUFTSixLQUFULENBQVg7QUFDQSxRQUFJQSxVQUFVLE1BQWQsRUFDRUcsS0FBS0UsT0FBTCxDQUNFLEtB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OztBQUVESSxvQkFBa0JDLElBQWxCLEVBQXdCO0FBQ3RCLFFBQUksT0FBT0EsSUFBUCxJQUFlLFdBQW5CLEVBQWdDO0FBQzlCLFdBQUtDLFdBQUwsQ0FBaUJyRSxHQUFqQixDQUFxQm9FLElBQXJCO0FBQ0E7QUFDRDtBQUNELFFBQUksT0FBTyxLQUFLM0QsT0FBTCxDQUFhLGlCQUFiLENBQVAsS0FBMkMsV0FBL0MsRUFDRSxLQUFLQSxPQUFMLENBQWEsaUJBQWIsRUFBZ0NzQixJQUFoQyxDQUFxQ0MsZUFBZTtBQUNsRCxVQUFJLEtBQUtNLFFBQUwsQ0FBY0MsTUFBZCxLQUF5QixDQUF6QixJQUE4QlAsWUFBWSxDQUFaLEVBQWVzQyxVQUFmLENBQTBCL0IsTUFBMUIsS0FDaEMsQ0FERixFQUVFLEtBQUs4QixXQUFMLENBQWlCckUsR0FBakIsQ0FBcUIsS0FBckI7QUFDSCxLQUpEO0FBTUg7O0FBM0o4Qzs7a0JBQTVCVixRO0FBZ0tyQlAsV0FBV3dGLGVBQVgsQ0FBMkIsQ0FBQ2pGLFFBQUQsQ0FBM0IiLCJmaWxlIjoiWm9uZU5vZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBzcGluYWxDb3JlID0gcmVxdWlyZShcInNwaW5hbC1jb3JlLWNvbm5lY3RvcmpzXCIpO1xuY29uc3QgZ2xvYmFsVHlwZSA9IHR5cGVvZiB3aW5kb3cgPT09IFwidW5kZWZpbmVkXCIgPyBnbG9iYWwgOiB3aW5kb3c7XG5pbXBvcnQgU3BpbmFsTm9kZSBmcm9tIFwiLi9TcGluYWxOb2RlXCJcbmltcG9ydCBab25lIGZyb20gXCIuL1pvbmVcIjtcbmltcG9ydCBTcGluYWxCSU1Hcm91cE9DIGZyb20gXCIuL1NwaW5hbEJJTUdyb3VwT0NcIlxubGV0IGdldFZpZXdlciA9IGZ1bmN0aW9uKCkge1xuICByZXR1cm4gZ2xvYmFsVHlwZS52O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgWm9uZU5vZGUgZXh0ZW5kcyBTcGluYWxOb2RlIHtcbiAgY29uc3RydWN0b3IoX3BhcmVudCwgX2VsZW1lbnQsIF9vcHRpb25zKSB7XG4gICAgc3VwZXIoX3BhcmVudCwgX2VsZW1lbnQsIF9vcHRpb25zKTtcbiAgfVxuXG4gIGluY3JlbWVudEVxdWlwZW1lbnROYW1lSWQoKSB7XG4gICAgZ2xvYmFsVHlwZS5vcGVyYXRpb25DZW50ZXIub3B0aW9ucy5lcXVpcGVtZW50TmFtZUlkXG4gICAgICAuc2V0KGdsb2JhbFR5cGUub3BlcmF0aW9uQ2VudGVyLm9wdGlvbnMuZXF1aXBlbWVudE5hbWVJZC5nZXQoKSArIDEpO1xuICAgIHJldHVybiBnbG9iYWxUeXBlLm9wZXJhdGlvbkNlbnRlci5vcHRpb25zLmVxdWlwZW1lbnROYW1lSWQuZ2V0KCk7XG4gIH1cblxuICBjcmVhdGVDaGlsZChfdHlwZSwgX3JlbFpvbmVBZ2dyZWdhdGVzTGlzdCwgX3pvbmVMaXN0KSB7XG4gICAgbGV0IHpvbmUgPSBuZXcgWm9uZShfdHlwZSlcbiAgICBpZiAoX3R5cGUgPT09IFwiWm9uZVwiKVxuICAgICAgem9uZS5zZXROYW1lKFxuICAgICAgICB0aGlzLmVsZW1lbnQubmFtZS5nZXQoKSArIFwiLVwiICsgdGhpcy5pbmNyZW1lbnRDaGlsZE5hbWVJZCgpLnRvU3RyaW5nKClcbiAgICAgIClcbiAgICBpZiAoX3R5cGUgPT09IFwiRXF1aXBlbWVudFwiKVxuICAgICAgem9uZS5zZXROYW1lKFwiIEVxdWlwZW1lbnQtXCIgKyB0aGlzLmluY3JlbWVudEVxdWlwZW1lbnROYW1lSWQoKS50b1N0cmluZygpKVxuXG4gICAgX3pvbmVMaXN0LmFkZFpvbmUoem9uZSk7XG4gICAgdGhpcy5lbGVtZW50LmFkZFJlbGF0aW9uKCdyZWxab25lQWdncmVnYXRlcycsIHpvbmUpXG4gICAgbGV0IHRyZWUgPSBuZXcgWm9uZU5vZGUodGhpcywgem9uZSk7XG5cbiAgICB0aGlzLmFkZENoaWxkKHRyZWUpO1xuICAgIGlmICghX3JlbFpvbmVBZ2dyZWdhdGVzTGlzdC5jb250YWluc0J5UmVsYXRpbmdJZCh0aGlzLmVsZW1lbnQuaWQuZ2V0KCkpKVxuICAgICAgX3JlbFpvbmVBZ2dyZWdhdGVzTGlzdC5hZGRSZWxab25lQWdncmVnYXRlcyh0aGlzLmVsZW1lbnQsIFt6b25lXSlcbiAgICBlbHNlIHtcbiAgICAgIGxldCByZWwgPSBfcmVsWm9uZUFnZ3JlZ2F0ZXNMaXN0LmdldEJ5UmVsYXRpbmdJZCh0aGlzLmVsZW1lbnQuaWQuZ2V0KCkpXG4gICAgICB0cnkge1xuICAgICAgICByZWwuYWRkUmVsYXRlZE9iamVjdHMoem9uZSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYWRkQklNT2JqZWN0KF9vYmplY3RJZCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5lbGVtZW50WydyZWxab25lQ29udGFpbnMnXSA9PT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgbGV0IEJJTUdyb3VwID0gbmV3IFNwaW5hbEJJTUdyb3VwT0MoKTtcbiAgICAgIEJJTUdyb3VwLmFkZEl0ZW0oX29iamVjdElkKVxuICAgICAgdGhpcy5lbGVtZW50LmFkZFJlbGF0aW9uKCdyZWxab25lQ29udGFpbnMnLCBCSU1Hcm91cClcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5lbGVtZW50WydyZWxab25lQ29udGFpbnMnXS5sb2FkKEJJTUdyb3VwTHN0ID0+IHtcbiAgICAgICAgQklNR3JvdXBMc3RbMF0uYWRkSXRlbShfb2JqZWN0SWQpXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhZGRUcmVlRnJvbVJlbGF0aW9uKF96b25lKSB7XG4gICAgdmFyIHRyZWUgPSBuZXcgWm9uZU5vZGUodGhpcywgX3pvbmUpO1xuICAgIHRoaXMuYWRkQ2hpbGQodHJlZSk7XG4gIH1cblxuICBnZXRTcGluYWxOb2RlQnlab25lSWQoX2lkKSB7XG4gICAgaWYgKHRoaXMuZWxlbWVudC5pZC5nZXQoKSA9PSBfaWQpXG4gICAgICByZXR1cm4gdGhpc1xuICAgIGVsc2Uge1xuICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IHNwaW5hbE5vZGUgPSB0aGlzLmNoaWxkcmVuW2luZGV4XTtcbiAgICAgICAgbGV0IHJlcyA9IHNwaW5hbE5vZGUuZ2V0U3BpbmFsTm9kZUJ5Wm9uZUlkKF9pZCk7XG4gICAgICAgIGlmIChyZXMgIT0gbnVsbClcbiAgICAgICAgICByZXR1cm4gc3BpbmFsTm9kZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBnZXRFcXVpcGVtZW50cygpIHtcbiAgICBsZXQgZXF1aXBlbWVudHNBcnJheSA9IFtdO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgZXF1aXAgPSB0aGlzLmNoaWxkcmVuW2ldLmVsZW1lbnQ7XG4gICAgICBjb25zdCBub2RlID0gdGhpcy5jaGlsZHJlbltpXTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKFwicmVjdXJcIiwgZXF1aXAudHlwZS5nZXQoKSk7XG4gICAgICAvLyBjb25zb2xlLmxvZyhlcXVpcGVtZW50c0FycmF5KTtcbiAgICAgIC8vIGNvbnNvbGUubG9nKGVxdWlwLmlzRXF1aXBlbWVudCgpKTtcbiAgICAgIGlmIChlcXVpcC5pc0VxdWlwZW1lbnQoKSlcbiAgICAgICAgZXF1aXBlbWVudHNBcnJheSA9IGVxdWlwZW1lbnRzQXJyYXkuY29uY2F0KGVxdWlwLmVsZW1lbnQpO1xuICAgICAgZWxzZSBlcXVpcGVtZW50c0FycmF5ID0gZXF1aXBlbWVudHNBcnJheS5jb25jYXQobm9kZS5nZXRFcXVpcGVtZW50cygpKTtcbiAgICB9XG4gICAgcmV0dXJuIGVxdWlwZW1lbnRzQXJyYXk7XG4gIH1cblxuXG4gIGFzeW5jIGdldEFsbEJJTUdyb3VwcygpIHtcbiAgICBsZXQgcmVzID0gW107XG4gICAgaWYgKHR5cGVvZiB0aGlzLmVsZW1lbnRbJ3JlbFpvbmVDb250YWlucyddICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBsZXQgQklNR3JvdXBMc3QgPSBhd2FpdCB0aGlzLnByb21pc2VMb2FkKHRoaXMuZWxlbWVudFsncmVsWm9uZUNvbnRhaW5zJ10pXG4gICAgICByZXMucHVzaChCSU1Hcm91cExzdFswXSk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLmNoaWxkcmVuW2ldO1xuICAgICAgICBsZXQgdG1wID0gYXdhaXQgY2hpbGQuZ2V0QWxsQklNR3JvdXBzKClcbiAgICAgICAgLy8gaWYgKHRtcCAhPT0gbnVsbClcbiAgICAgICAgcmVzID0gcmVzLmNvbmNhdCh0bXApO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgcHJvbWlzZUxvYWQoX3B0cikge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgIF9wdHIubG9hZChyZXNvbHZlKTtcbiAgICB9KTtcbiAgfVxuXG5cblxuXG4gIGFzeW5jIGdldEl0ZW1zKCkge1xuICAgIGxldCB0ID0gW107XG4gICAgaWYgKHR5cGVvZiB0aGlzLmVsZW1lbnRbJ3JlbFpvbmVDb250YWlucyddICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBsZXQgQklNR3JvdXBMc3QgPSBhd2FpdCB0aGlzLnByb21pc2VMb2FkKHRoaXMuZWxlbWVudFsncmVsWm9uZUNvbnRhaW5zJ10pXG4gICAgICB0ID0gdC5jb25jYXQoQklNR3JvdXBMc3RbMF0uYXJyYXlPZklkKCkpO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGVsZW1lbnQgPSB0aGlzLmNoaWxkcmVuW2ldO1xuICAgICAgICBsZXQgY2hpbGRJdGVtcyA9IGF3YWl0IGVsZW1lbnQuZ2V0SXRlbXMoKTtcbiAgICAgICAgLy8gaWYgKHR5cGVvZiBjaGlsZEl0ZW1zICE9PSBcInVuZGVmaW5lZFwiKVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNoaWxkSXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjb25zdCBlbGVtZW50ID0gY2hpbGRJdGVtc1tpXTtcbiAgICAgICAgICBpZiAodC5pbmRleE9mKGVsZW1lbnQpID09PSAtMSkgdC5wdXNoKGVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0O1xuICB9XG5cbiAgYXN5bmMgc2V0QWxsRGlzcGxheXMoX2Jvb2wpIHtcbiAgICBsZXQgdCA9IGF3YWl0IHRoaXMuZ2V0QWxsQklNR3JvdXBzKCk7XG4gICAgLy8gaWYgKHQgIT0gbnVsbClcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdC5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgIGNvbnN0IGVsZW1lbnQgPSB0W2luZGV4XTtcbiAgICAgIGVsZW1lbnQuZGlzcGxheS5zZXQoX2Jvb2wpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldEFsbERhdGFzQWN0aXZlKF9ib29sKSB7XG4gICAgbGV0IHQgPSBhd2FpdCB0aGlzLmdldEFsbEJJTUdyb3VwcygpO1xuICAgIC8vIGlmICh0ICE9IG51bGwpXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHQubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICBjb25zdCBlbGVtZW50ID0gdFtpbmRleF07XG4gICAgICBlbGVtZW50LmFjdGl2ZS5zZXQoX2Jvb2wpO1xuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZVNob3dDb250ZW50KGJvb2wpIHtcbiAgICBpZiAodHlwZW9mIGJvb2wgIT0gXCJ1bmRlZmluZWRcIikge1xuICAgICAgdGhpcy5zaG93Q29udGVudC5zZXQoYm9vbCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdGhpcy5lbGVtZW50WydyZWxab25lQ29udGFpbnMnXSAhPT0gXCJ1bmRlZmluZWRcIilcbiAgICAgIHRoaXMuZWxlbWVudFsncmVsWm9uZUNvbnRhaW5zJ10ubG9hZChCSU1Hcm91cExzdCA9PiB7XG4gICAgICAgIGlmICh0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCAmJiBCSU1Hcm91cExzdFswXS5CSU1PYmplY3RzLmxlbmd0aCA9PT1cbiAgICAgICAgICAwKVxuICAgICAgICAgIHRoaXMuc2hvd0NvbnRlbnQuc2V0KGZhbHNlKTtcbiAgICAgIH0pO1xuXG4gIH1cblxuXG59XG5cbnNwaW5hbENvcmUucmVnaXN0ZXJfbW9kZWxzKFtab25lTm9kZV0pOyJdfQ==